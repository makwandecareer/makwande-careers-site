<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Candidate Profile — Makwande Careers</title>

  <!-- Brand / UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="/assets/css/style.css" rel="stylesheet" />

  <style>
    /* Light, classy LinkedIn-ish look */
    .cover-profile { background: linear-gradient(135deg, #eaf4ef, #ffffff); }
    .avatar-wrap { position: relative; width: 112px; height: 112px; }
    .avatar-wrap img { width: 112px; height: 112px; object-fit: cover; border-radius: 50%; border: 4px solid #fff; box-shadow: var(--shadow); }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .65rem; border:1px solid var(--border); border-radius:999px; background:#fff; }
    .chip .remove { border:none; background:transparent; line-height:1; }
    .card-soft { border:1px solid var(--border); background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); }
    .muted { color: var(--muted); }
    .btn-soft { background:#f4f6f5; border:1px solid var(--border); }
  </style>
</head>
<body>
  <!-- Navbar shell (main.js injects links) -->
  <nav class="nav-wrap bg-white sticky-top border-bottom">
    <div class="container-xxl py-2 d-flex align-items-center gap-3">
        <div class="d-flex flex-wrap gap-2 ms-auto">
            <button class="btn btn-soft" id="btnChangePhoto"><i class="bi bi-camera"></i> Change photo</button>
            <label class="btn btn-primary mb-0" for="resumeInput"><i class="bi bi-upload"></i> Upload CV</label>
            <input id="resumeInput" type="file" accept=".pdf,.doc,.docx" class="visually-hidden">
            <a id="resumeLink" class="btn btn-outline-secondary d-none" href="#" target="_blank" rel="noopener"><i class="bi bi-file-earmark-text"></i> View CV</a>
          
            <!-- Add this button here -->
            <button id="btnCopyPublic" class="btn btn-outline-secondary">
              <i class="bi bi-link-45deg"></i> 
            </button>
          </div>
          
  <!-- Header / identity -->
  <header class="cover-profile py-4">
    <div class="container-xxl">
      <div class="d-flex flex-wrap align-items-end gap-3">
        <div class="avatar-wrap">
          <img id="avatarImg" src="/assets/img/avatar-placeholder.png" alt="Your profile photo" />
          <input id="avatarInput" type="file" accept="image/*" class="visually-hidden">
        </div>
        <div class="flex-grow-1">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 id="nameText" class="mb-0 h3">Your Name</h1>
            <span class="badge text-bg-success" id="visibilityBadge">Public</span>
          </div>
          <div class="muted mt-1" id="headlineText">Role / Headline</div>
          <div class="muted"><i class="bi bi-geo-alt"></i> <span id="locationText">SADC Region</span></div>
        </div>
        <div class="d-flex flex-wrap gap-2 ms-auto">
          <button class="btn btn-soft" id="btnChangePhoto"><i class="bi bi-camera"></i> Change photo</button>
          <label class="btn btn-primary mb-0" for="resumeInput"><i class="bi bi-upload"></i> Upload CV</label>
          <input id="resumeInput" type="file" accept=".pdf,.doc,.docx" class="visually-hidden">
          <a id="resumeLink" class="btn btn-outline-secondary d-none" href="#" target="_blank" rel="noopener"><i class="bi bi-file-earmark-text"></i> View CV</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main two-column layout -->
  <main class="container-xxl my-4">
    <div class="row g-4">
      <!-- Left column: editable basics -->
      <div class="col-lg-4">
        <div class="card-soft p-3">
          <h5 class="mb-3">Basics</h5>
          <div class="mb-3">
            <label class="form-label">Full name</label>
            <input id="nameInput" class="form-control" placeholder="e.g., Thandiwe M." />
          </div>
          <div class="mb-3">
            <label class="form-label">Headline</label>
            <input id="headlineInput" class="form-control" placeholder="e.g., Data Analyst • SQL • Power BI" />
          </div>
          <div class="mb-3">
            <label class="form-label">Location (SADC)</label>
            <select id="locationSelect" class="form-select">
              <option value="">Select country</option>
              <option>South Africa</option><option>Botswana</option><option>Namibia</option>
              <option>Zimbabwe</option><option>Zambia</option><option>Lesotho</option>
              <option>Eswatini</option><option>Angola</option><option>Mozambique</option>
              <option>Malawi</option><option>Tanzania</option><option>DR Congo</option>
              <option>Mauritius</option><option>Seychelles</option><option>Comoros</option>
              <option>Madagascar</option>
            </select>
          </div>
          <div class="mb-3 d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-medium">Profile visibility</div>
              <div class="small text-muted">Shown to employers when public</div>
            </div>
            <div class="form-check form-switch m-0">
              <input id="visibilityToggle" class="form-check-input" type="checkbox" checked>
            </div>
          </div>
          <button id="btnSaveBasics" class="btn btn-primary w-100">Save basics</button>
        </div>

        <div class="card-soft p-3 mt-3">
          <h6 class="mb-2">Skills</h6>
          <div id="skillsWrap" class="d-flex flex-wrap gap-2 mb-2"></div>
          <div class="input-group">
            <input id="skillInput" class="form-control" placeholder="Add a skill (Enter)" />
            <button id="btnAddSkill" class="btn btn-outline-secondary">Add</button>
          </div>
        </div>

        <div class="card-soft p-3 mt-3">
          <h6 class="mb-2">Job Preferences</h6>
          <div class="mb-2">
            <label class="form-label">Open to opportunities</label>
            <select id="prefOpen" class="form-select">
              <option value="open">Open</option>
              <option value="considering">Considering</option>
              <option value="not_open">Not open</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Work type</label>
            <select id="prefWork" class="form-select">
              <option>On-site</option><option>Hybrid</option><option>Remote</option>
            </select>
          </div>
          <button id="btnSavePrefs" class="btn btn-outline-primary w-100">Save preferences</button>
        </div>
      </div>

      <!-- Right column: about, experience, education -->
      <div class="col-lg-8">
        <div class="card-soft p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">About</h5>
            <div class="small text-muted" id="aboutSavedHint" style="opacity:.65">Auto-saves</div>
          </div>
          <textarea id="aboutInput" class="form-control mt-2" rows="5" placeholder="Write a short summary about your background, strengths and goals…"></textarea>
        </div>

        <div class="card-soft p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Experience</h5>
            <button class="btn btn-soft" data-bs-toggle="modal" data-bs-target="#expModal"><i class="bi bi-plus-lg"></i> Add</button>
          </div>
          <div id="expList" class="mt-3"></div>
        </div>

        <div class="card-soft p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Education</h5>
            <button class="btn btn-soft" data-bs-toggle="modal" data-bs-target="#eduModal"><i class="bi bi-plus-lg"></i> Add</button>
          </div>
          <div id="eduList" class="mt-3"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Experience Modal -->
  <div class="modal fade" id="expModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="expForm" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">Add Experience</h6><button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Title</label>
            <input name="title" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Company</label>
            <input name="company" class="form-control" required>
          </div>
          <div class="row">
            <div class="col"><label class="form-label">Start</label><input name="start" type="month" class="form-control" required></div>
            <div class="col"><label class="form-label">End</label><input name="end" type="month" class="form-control"></div>
          </div>
          <div class="mt-2">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" type="submit">Save</button></div>
      </form>
    </div>
  </div>

  <!-- Education Modal -->
  <div class="modal fade" id="eduModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="eduForm" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">Add Education</h6><button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Institution</label><input name="school" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Degree / Program</label><input name="degree" class="form-control" required></div>
          <div class="row">
            <div class="col"><label class="form-label">Start</label><input name="start" type="month" class="form-control" required></div>
            <div class="col"><label class="form-label">End</label><input name="end" type="month" class="form-control"></div>
          </div>
          <div class="mt-2"><label class="form-label">Notes</label><textarea name="notes" class="form-control" rows="3"></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" type="submit">Save</button></div>
      </form>
    </div>
  </div>

  <footer class="border-top mt-5 py-4">
    <div class="container-xxl d-flex flex-wrap align-items-center justify-content-between">
      <div class="small text-muted">© <span id="year"></span> Makwande Careers</div>
      <div class="d-flex gap-3 small">
        <a href="/jobs.html">Jobs</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/sitemap.html">Sitemap</a>
      </div>
    </div>
  </footer>

  <!-- 1) Global API helper (one-liner) -->
  <script>window.fetchAPI=(p,o={})=>fetch('/api'+p,{credentials:'include',...o});</script>

  <!-- 2) Vendor + shared app JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/assets/js/main.js?v=3"></script>


  <!-- 3) Page logic -->
  <script type="module">
    // Utils
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];
    const debounce = (fn, ms=700)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const pid = profile.slug || profile.username || profile.id || '';
const url = location.origin + '/public-profile.html' + (pid ? ('?id=' + encodeURIComponent(pid)) : '');
const btnCopyPublic = document.getElementById('btnCopyPublic');

    // DOM
    const nameText = $('#nameText');
    const headlineText = $('#headlineText');
    const locationText = $('#locationText');
    const visibilityBadge = $('#visibilityBadge');
    const nameInput = $('#nameInput');
    const headlineInput = $('#headlineInput');
    const locationSelect = $('#locationSelect');
    const visibilityToggle = $('#visibilityToggle');
    const aboutInput = $('#aboutInput');
    const aboutSavedHint = $('#aboutSavedHint');
    const skillsWrap = $('#skillsWrap');
    const skillInput = $('#skillInput');
    const btnAddSkill = $('#btnAddSkill');
    const btnSaveBasics = $('#btnSaveBasics');
    const btnSavePrefs = $('#btnSavePrefs');
    const avatarImg = $('#avatarImg');
    const avatarInput = $('#avatarInput');
    const resumeInput = $('#resumeInput');
    const resumeLink = $('#resumeLink');
    const btnChangePhoto = $('#btnChangePhoto');

    const expList = $('#expList');
    const eduList = $('#eduList');
    const expForm = $('#expForm');
    const eduForm = $('#eduForm');

    // Footer year and nav safety
    const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear(); if (window.injectNav) window.injectNav();

    // ---- Load current profile
    let profile = {};
    async function loadProfile(){
      try {
        const r = await fetchAPI('/profile');
        if (!r.ok) throw new Error('Profile load '+r.status);
        profile = await r.json();
      } catch {
        profile = {};
      }
      renderProfile();
      // Optional resume URL
      try {
        const r = await fetchAPI('/profile/resume');
        if (r.ok) {
          const { url } = await r.json();
          if (url) { resumeLink.classList.remove('d-none'); resumeLink.href = url; }
        }
      } catch {}
    }

    function renderProfile(){
      const p = profile || {};
      nameText.textContent = p.name || 'Your Name';
      headlineText.textContent = p.headline || 'Role / Headline';
      locationText.textContent = p.location || 'SADC Region';
      visibilityBadge.textContent = p.visibility === 'private' ? 'Private' : 'Public';
      visibilityBadge.className = 'badge ' + (p.visibility === 'private' ? 'text-bg-secondary' : 'text-bg-success');

      nameInput.value = p.name || '';
      headlineInput.value = p.headline || '';
      locationSelect.value = p.location || '';
      visibilityToggle.checked = (p.visibility !== 'private');
      aboutInput.value = p.about || '';

      skillsWrap.innerHTML = '';
      (p.skills || []).forEach(addSkillChip);

      renderList(expList, p.experience || [], 'No experience yet.');
      renderList(eduList, p.education || [], 'No education added yet.');
      if (p.photo_url) avatarImg.src = p.photo_url;
    }

    function renderList(container, items, emptyText){
      if (!items.length) { container.innerHTML = `<div class="text-muted">${emptyText}</div>`; return; }
      container.innerHTML = items.map(it => `
        <div class="d-flex gap-3 py-2">
          <div class="flex-grow-1">
            <div class="fw-semibold">${escapeHtml(it.title || it.degree || '')} ${it.company ? '· <span class="text-muted">'+escapeHtml(it.company)+'</span>' : ''}</div>
            <div class="small text-muted">${[it.school, it.location].filter(Boolean).join(' · ')}</div>
            <div class="small text-muted">${fmtMonth(it.start)} – ${it.end ? fmtMonth(it.end) : 'Present'}</div>
            ${it.description ? `<div class="small mt-1">${escapeHtml(it.description || it.notes || '')}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    const escapeHtml = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtMonth = v => v ? new Date(v+'-01').toLocaleString(undefined,{month:'short',year:'numeric'}) : '';

    // ---- Save basics
    btnSaveBasics.addEventListener('click', async ()=>{
      await savePatch({
        name: nameInput.value.trim(),
        headline: headlineInput.value.trim(),
        location: locationSelect.value || null,
        visibility: visibilityToggle.checked ? 'public' : 'private'
      });
      Object.assign(profile, { name:nameInput.value.trim(), headline:headlineInput.value.trim(), location:locationSelect.value, visibility: visibilityToggle.checked?'public':'private' });
      renderProfile();
    });

    // ---- About autosave (debounced)
    const saveAbout = debounce(async ()=>{
      aboutSavedHint.textContent = 'Saving…';
      await savePatch({ about: aboutInput.value });
      profile.about = aboutInput.value;
      aboutSavedHint.textContent = 'Saved';
      setTimeout(()=> aboutSavedHint.textContent='Auto-saves', 1200);
    }, 700);
    aboutInput.addEventListener('input', saveAbout);

    // ---- Skills
    function addSkillChip(skill){
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `<i class="bi bi-lightning-charge"></i><span>${escapeHtml(skill)}</span><button class="remove" title="Remove" aria-label="Remove"><i class="bi bi-x"></i></button>`;
      chip.querySelector('.remove').addEventListener('click', async ()=>{
        profile.skills = (profile.skills || []).filter(s => s.toLowerCase() !== skill.toLowerCase());
        await savePatch({ skills: profile.skills });
        chip.remove();
      });
      skillsWrap.appendChild(chip);
    }
    function tryAddSkill(){
      const s = skillInput.value.trim();
      if (!s) return;
      profile.skills = Array.from(new Set([...(profile.skills||[]), s]));
      savePatch({ skills: profile.skills }).then(()=>{
        addSkillChip(s); skillInput.value=''; skillInput.focus();
      });
    }
    btnAddSkill.addEventListener('click', tryAddSkill);
    skillInput.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); tryAddSkill(); } });

    // ---- Photo upload
    btnChangePhoto.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', async ()=>{
      if (!avatarInput.files?.length) return;
      const fd = new FormData(); fd.append('photo', avatarInput.files[0]);
      const r = await fetchAPI('/profile/photo', { method:'POST', body: fd });
      if (r.ok){
        const { url } = await r.json().catch(()=>({}));
        if (url) avatarImg.src = url; // backend returns new URL
      }
    });

    // ---- Resume upload
    resumeInput.addEventListener('change', async ()=>{
      if (!resumeInput.files?.length) return;
      const fd = new FormData(); fd.append('resume', resumeInput.files[0]);
      const r = await fetchAPI('/profile/resume', { method:'POST', body: fd });
      if (r.ok){
        const { url } = await r.json().catch(()=>({}));
        if (url) { resumeLink.classList.remove('d-none'); resumeLink.href = url; }
      }
    });

    // ---- Preferences
    btnSavePrefs.addEventListener('click', async ()=>{
      await savePatch({ preferences: { open: $('#prefOpen').value, work: $('#prefWork').value } });
    });

    // ---- Experience / Education modals
    expForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(expForm);
      const payload = Object.fromEntries(fd.entries());
      const r = await fetchAPI('/profile/experience', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (r.ok){
        (profile.experience ||= []).unshift(payload);
        renderList(expList, profile.experience, 'No experience yet.');
        expForm.reset();
        bootstrap.Modal.getInstance(document.getElementById('expModal')).hide();
      }
    });

    eduForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(eduForm);
      const payload = Object.fromEntries(fd.entries());
      const r = await fetchAPI('/profile/education', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (r.ok){
        (profile.education ||= []).unshift(payload);
        renderList(eduList, profile.education, 'No education added yet.');
        eduForm.reset();
        bootstrap.Modal.getInstance(document.getElementById('eduModal')).hide();
      }
    });

    // ---- Shared PATCH helper
    async function savePatch(patch){
      try {
        const r = await fetchAPI('/profile', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(patch) });
        return r.ok;
      } catch { return false; }
    }

    // Go!
    await loadProfile();
  </script>
  <script defer src="/assets/js/pages.js?v=1"></script>`r`n</body>
</html>
