<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>AutoApply — Dashboard</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #161a22;
      --muted: #8a93a6;
      --text: #e7ecf3;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --border: #242a36;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 16px clamp(16px, 4vw, 32px);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      font-weight: 700;
      letter-spacing: .3px;
    }
    .tag {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
    }
    .user {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #1b2230;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      font-weight: 600;
    }
    .btn:hover { border-color: #324057; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: transparent; }
    .btn.accent {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #0b1220;
      border: none;
    }
    .btn.danger {
      background: #2a1212;
      border-color: #3a1a1a;
      color: #ffb4b4;
    }

    main {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 clamp(16px, 4vw, 32px) 48px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 300px 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    .card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 14px;
    }
    .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(110,231,183,0.0);
    }
    .dot.ok { background: var(--accent); box-shadow: 0 0 0 3px rgba(110,231,183,0.15); }
    .dot.err { background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,0.15); }

    .list {
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }
    .job {
      border: 1px solid var(--border);
      background: #121723;
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 6px;
    }
    .job .meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .job .title {
      font-weight: 700;
      line-height: 1.3;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .empty {
      color: var(--muted);
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 18px;
      text-align: center;
    }
    .help {
      margin-top: 24px;
      color: var(--muted);
      font-size: 13px;
    }
    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { background: #0c0f14; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">AutoApply</div>
      <div class="tag">Dashboard</div>
    </div>
    <div class="user">
      <div id="currentUser" class="tag">…</div>
      <button id="logoutBtn" class="btn danger">Log out</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h3>API Status</h3>
      <div class="status">
        <span id="apiDot" class="dot"></span>
        <span id="apiStatus">Checking…</span>
      </div>

      <div class="help">
        Having trouble? Ensure your API URL in <code>scripts/config.js</code> is correct and your
        Render web service is green.
      </div>
    </section>

    <section class="card">
      <h3>Latest Jobs</h3>
      <div id="jobsStatus" class="status">
        <span class="dot" id="jobsDot"></span>
        <span>Loading…</span>
      </div>
      <div id="jobsList" class="list" aria-live="polite"></div>
      <div class="help">
        This list calls <code>GET /jobs</code> with your auth token. Adjust the property names to
        match your API response if needed.
      </div>
    </section>
  </main>

  <!-- 1) Your API base URL -->
  <script src="/scripts/config.js"></script>

  <!-- 2) Page logic -->
  <script>
    // Resolve API base URL (from config.js), with a safe fallback:
    const API = (window.CONFIG && window.CONFIG.API_BASE_URL)
      ? window.CONFIG.API_BASE_URL.replace(/\/+$/, '')
      : 'https://autoapplyapp-api.onrender.com'; // fallback if CONFIG is missing

    // Read token placed by your login page
    const token = localStorage.getItem('token') || '';

    // UI elements
    const elUser     = document.getElementById('currentUser');
    const elLogout   = document.getElementById('logoutBtn');
    const elJobsList = document.getElementById('jobsList');
    const elJobsStat = document.getElementById('jobsStatus');
    const elJobsDot  = document.getElementById('jobsDot');
    const elApiStat  = document.getElementById('apiStatus');
    const elApiDot   = document.getElementById('apiDot');

    function authHeaders() {
      const h = { 'Content-Type': 'application/json' };
      if (token) h['Authorization'] = 'Bearer ' + token;
      return h;
    }

    function setDot(el, ok) {
      el.classList.remove('ok', 'err');
      el.classList.add(ok ? 'ok' : 'err');
    }

    async function checkApi() {
      try {
        const r = await fetch(API + '/health', { headers: authHeaders() });
        const ok = r.ok;
        setDot(elApiDot, ok);
        elApiStat.textContent = ok ? 'API online' : `API error (${r.status})`;
      } catch (e) {
        setDot(elApiDot, false);
        elApiStat.textContent = 'API unreachable';
      }
    }

    async function loadMe() {
      if (!token) {
        elUser.textContent = 'Not signed in';
        return;
      }
      try {
        const r = await fetch(API + '/auth/me', { headers: authHeaders() });
        if (r.ok) {
          const me = await r.json();
          // Adjust to your API shape: { name, email } or similar
          elUser.textContent = me.name ? `${me.name} • ${me.email || ''}`.trim() : (me.email || 'Signed in');
        } else {
          elUser.textContent = 'Auth expired — please log in again';
        }
      } catch {
        elUser.textContent = 'Unable to fetch user';
      }
    }

    function jobCard(job) {
      // Adjust keys (title, company, location, link) to match your API
      const title    = job.title || job.position || 'Untitled';
      const company  = job.company || job.org || 'Unknown company';
      const location = job.location || job.city || '—';
      const link     = job.url || job.link || '#';

      const div = document.createElement('div');
      div.className = 'job';

      const t = document.createElement('div');
      t.className = 'title';
      t.textContent = title;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <span>${company}</span>
        <span>•</span>
        <span>${location}</span>
        ${link && link !== '#' ? `<span>•</span><a href="${link}" target="_blank" rel="noopener">View</a>` : ''}
      `;

      const row = document.createElement('div');
      row.className = 'row';
      const btn = document.createElement('button');
      btn.className = 'btn accent';
      btn.textContent = 'Apply';
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Applying…';
        try {
          const res = await fetch(API + '/jobs/apply', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ jobId: job.id || job._id || job.url || '' })
          });
          if (res.ok) {
            btn.textContent = 'Applied ✓';
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Apply'; btn.disabled = false; }, 1200);
          }
        } catch {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = 'Apply'; btn.disabled = false; }, 1200);
        }
      };

      row.appendChild(btn);
      div.appendChild(t);
      div.appendChild(meta);
      div.appendChild(row);
      return div;
    }

    async function loadJobs() {
      elJobsList.innerHTML = '';
      setDot(elJobsDot, true);
      try {
        const r = await fetch(API + '/jobs', { headers: authHeaders() });
        if (!r.ok) {
          setDot(elJobsDot, false);
          elJobsStat.querySelector('span:last-child').textContent = `Failed (${r.status})`;
          elJobsList.innerHTML = `<div class="empty">Couldn’t load jobs. Check your API logs.</div>`;
          return;
        }
        const data = await r.json();
        const jobs = Array.isArray(data) ? data : (data.jobs || []);
        elJobsStat.querySelector('span:last-child').textContent = `Loaded ${jobs.length} job${jobs.length === 1 ? '' : 's'}`;
        if (jobs.length === 0) {
          elJobsList.innerHTML = `<div class="empty">No jobs yet.</div>`;
          return;
        }
        const frag = document.createDocumentFragment();
        jobs.slice(0, 20).forEach(j => frag.appendChild(jobCard(j)));
        elJobsList.appendChild(frag);
      } catch (e) {
        setDot(elJobsDot, false);
        elJobsStat.querySelector('span:last-child').textContent = 'Network error';
        elJobsList.innerHTML = `<div class="empty">Network error while loading jobs.</div>`;
      }
    }

    elLogout.addEventListener('click', async () => {
      try {
        await fetch(API + '/auth/logout', { method: 'POST', headers: authHeaders() });
      } catch {}
      localStorage.removeItem('token');
      location.href = '/login.html';
    });

    // Kick off
    checkApi();
    loadMe();
    loadJobs();
  </script>
</body>
</html>




