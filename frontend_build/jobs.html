<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Makwande Careers — Jobs</title>

  <!-- Bootstrap 5 (CSS + JS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#f7f8fa; }
    .navbar-brand { font-weight:700; }
    .job-card .card-title { line-height:1.2; }
    .job-card .truncate { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .badge-remote { background:#16a34a; }
    .small-muted { color:#6b7280; font-size:.9rem; }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">Makwande Careers</a>
      <div class="ms-auto small-muted">
        <span id="lastUpdated">Loading…</span>
      </div>
    </div>
  </nav>

  <!-- Page -->
  <main class="container py-4">
    <!-- Search -->
    <div class="row g-3 align-items-center mb-3">
      <div class="col-12 col-md-8">
        <label for="q" class="form-label mb-1 fw-semibold">Search jobs</label>
        <input id="q" type="search" class="form-control form-control-lg"
               placeholder="Title, company, or location…" autocomplete="off">
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1 fw-semibold">API</label>
        <input id="apiBase" type="url" class="form-control"
               placeholder="https://autoapply-api.onrender.com (optional override)">
        <div class="form-text">
          You can override the API for testing. Leave empty for default.
        </div>
      </div>
    </div>

    <!-- Status / Errors -->
    <div id="status" class="alert d-none" role="alert"></div>

    <!-- Jobs list -->
    <div id="jobsList" class="row gy-3"></div>

    <!-- Empty state -->
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <h5 class="mb-1">No jobs found</h5>
      <p class="mb-0">Try a different search.</p>
    </div>
  </main>

<script>
(() => {
  // ---------- Config ----------
  const DEFAULT_API = 'https://autoapply-api.onrender.com';
  const qs = new URLSearchParams(location.search);
  const savedApi = localStorage.getItem('api_base') || '';
  const API_BASE_INPUT = document.getElementById('apiBase');
  API_BASE_INPUT.value = qs.get('api') || savedApi;

  const API_BASE = () => (API_BASE_INPUT.value.trim() || DEFAULT_API).replace(/\/+$/,'');
  const JOBS_URL = (q) => API_BASE() + '/api/jobs' + (q ? ('?q=' + encodeURIComponent(q)) : '');

  // ---------- Elements ----------
  const qInput = document.getElementById('q');
  const listEl = document.getElementById('jobsList');
  const emptyEl = document.getElementById('emptyState');
  const statusEl = document.getElementById('status');
  const lastUpdated = document.getElementById('lastUpdated');

  let DEBOUNCE = null;

  // ---------- Utils ----------
  const escapeHTML = (s) => (s || '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  const fmtDate = (d) => {
    if (!d) return '';
    try {
      const dt = typeof d === 'string' ? new Date(d) : d;
      if (!isFinite(dt)) return '';
      return dt.toLocaleDateString();
    } catch { return ''; }
  };

  const relTime = (d) => {
    try {
      const dt = new Date(d);
      const diff = (Date.now() - dt.getTime()) / 1000;
      if (isNaN(diff)) return '';
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff/60) + 'm ago';
      if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
      return Math.floor(diff/86400) + 'd ago';
    } catch { return ''; }
  };

  const setStatus = (msg, type='info') => {
    statusEl.className = alert alert-${type};
    statusEl.textContent = msg;
    statusEl.classList.toggle('d-none', !msg);
  };

  const setUpdated = () => {
    lastUpdated.textContent = 'Last updated: ' + new Date().toLocaleString();
  };

  // ---------- Render ----------
  function renderJobs(jobs) {
    listEl.innerHTML = '';
    emptyEl.classList.toggle('d-none', jobs.length !== 0);

    const frag = document.createDocumentFragment();

    jobs.forEach(j => {
      const title = escapeHTML(j.title || '');
      const company = escapeHTML(j.company || '');
      const location = escapeHTML(j.location || '');
      const desc = escapeHTML(j.description || '');
      const apply = j.apply_url || '#';
      const remote = j.remote ? '<span class="badge badge-remote">Remote</span>' : '';
      const posted = j.posted_at ? relTime(j.posted_at) : '';
      const closeOn = j.closing_date ? (' • closes ' + fmtDate(j.closing_date)) : '';

      const col = document.createElement('div');
      col.className = 'col-12';

      col.innerHTML = `
        <div class="card job-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h5 class="card-title mb-0">${title}</h5>
              ${remote}
            </div>
            <div class="small-muted mb-2">${company}${location ? ' • ' + location : ''}</div>
            <p class="card-text truncate">${desc}</p>
            <div class="d-flex align-items-center gap-3">
              <a class="btn btn-primary" href="${apply}" target="_blank" rel="noopener">Apply</a>
              <span class="small-muted">${posted ? 'Posted ' + posted : ''}${closeOn}</span>
              <span class="small-muted ms-auto">${j.country ? escapeHTML(j.country) : ''}</span>
            </div>
          </div>
        </div>`;
      frag.appendChild(col);
    });

    listEl.appendChild(frag);
  }

  // ---------- Data ----------
  async function fetchJobs(q='') {
    const url = JOBS_URL(q);
    setStatus('');
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('API ' + res.status);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('Bad API shape');
      renderJobs(data);
      setUpdated();
    } catch (err) {
      console.error(err);
      renderJobs([]);
      setStatus('Could not load jobs (' + (err.message || err) + '). Check API/CSV and try again.', 'warning');
    }
  }

  // ---------- Events ----------
  qInput.addEventListener('input', () => {
    clearTimeout(DEBOUNCE);
    DEBOUNCE = setTimeout(() => fetchJobs(qInput.value.trim()), 250);
  });

  API_BASE_INPUT.addEventListener('change', () => {
    const v = API_BASE_INPUT.value.trim();
    if (v) localStorage.setItem('api_base', v); else localStorage.removeItem('api_base');
    fetchJobs(qInput.value.trim());
  });

  // Initial load
  fetchJobs('');
})();
</script>
</body>
</html>