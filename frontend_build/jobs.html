<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Makwande Careers — Jobs</title>

  <!-- Bootstrap (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ✅ use the stylesheet that actually exists in your repo -->
  <link href="light-green.css" rel="stylesheet">

  <!-- PapaParse for CSV fallback -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Makwande Careers</a>
      <span class="text-muted small" id="lastUpdated"></span>
    </div>
  </nav>

  <main class="container my-4">
    <!-- Filters (keep minimal; safe even if elements are removed) -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md">
        <input id="searchInput" class="form-control" placeholder="Search title, company, keyword…">
      </div>
      <div class="col-6 col-md-3">
        <select id="locFilter" class="form-select"><option value="">All locations</option></select>
      </div>
      <div class="col-6 col-md-3">
        <select id="companyFilter" class="form-select"><option value="">All companies</option></select>
      </div>
      <div class="col-12 col-md-auto d-flex align-items-center gap-2">
        <input class="form-check-input" type="checkbox" id="remoteToggle">
        <label class="form-check-label" for="remoteToggle">Remote only</label>
      </div>
      <!-- “Add Job” is optional. If you remove it, JS won’t crash. -->
      <div class="col-12 col-md-auto text-md-end">
        <a id="addJobBtn" href="post_job.html" class="btn btn-success">+ Add Job</a>
      </div>
    </div>

    <div id="emptyState" class="alert alert-warning d-none">
      No jobs to show yet. Please check back soon.
    </div>

    <div id="jobsList" class="row row-cols-1 row-cols-md-2 g-3"></div>
  </main>

  <script defer>
  document.addEventListener('DOMContentLoaded', () => {
    // ✅ point this at your working backend
    const API_BASE = "https://autoapply-api.onrender.com";

    const $ = (sel) => document.querySelector(sel);
    const jobsListEl   = $("#jobsList");
    const emptyStateEl = $("#emptyState");
    const lastUpdated  = $("#lastUpdated");
    const searchEl     = $("#searchInput");
    const locEl        = $("#locFilter");
    const companyEl    = $("#companyFilter");
    const remoteEl     = $("#remoteToggle");
    const addBtn       = $("#addJobBtn"); // may be null – that’s fine

    let JOBS = [];

    // ---------- load ----------
    async function loadJobs() {
      // try API first
      try {
        const res = await fetch(${API_BASE.replace(/\/$/,"")}/api/jobs?limit=1000&ts=${Date.now()}, { cache: "no-store" });
        if (!res.ok) throw new Error("API "+res.status);
        JOBS = await res.json();
      } catch {
        // fallback to CSV in same folder
        const csvRes = await fetch(jobs.csv?ts=${Date.now()});
        const csvText = await csvRes.text();
        JOBS = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
      }
      initFilters(JOBS);
      render();
      if (lastUpdated) lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();
    }

    // ---------- filters ----------
    function initFilters(list) {
      const uniq = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      const locs = uniq(list.map(j => j.location || j.loc || ""));
      const comps = uniq(list.map(j => j.company || j.employer || ""));

      if (locEl) {
        locEl.innerHTML = <option value="">All locations</option> + locs.map(v=><option>${escapeHtml(v)}</option>).join("");
      }
      if (companyEl) {
        companyEl.innerHTML = <option value="">All companies</option> + comps.map(v=><option>${escapeHtml(v)}</option>).join("");
      }
    }

    function activeFilters(j) {
      const q = (searchEl?.value || "").toLowerCase().trim();
      const loc = locEl?.value || "";
      const comp = companyEl?.value || "";
      const remoteOnly = !!(remoteEl && remoteEl.checked);

      const title = (j.title || "").toLowerCase();
      const company = (j.company || j.employer || "").toLowerCase();
      const location = (j.location || "").toLowerCase();

      const matchesQ = !q || title.includes(q) || company.includes(q) || (j.description||"").toLowerCase().includes(q);
      const matchesLoc = !loc || location === loc.toLowerCase();
      const matchesComp = !comp || company === comp.toLowerCase();
      const isRemote = /remote/.test(location) || String(j.remote || "").toLowerCase() === "true";

      return matchesQ && matchesLoc && matchesComp && (!remoteOnly || isRemote);
    }

    // ---------- render ----------
    function render() {
      const filtered = (JOBS || []).filter(activeFilters);
      if (!filtered.length) {
        emptyStateEl?.classList.remove("d-none");
        jobsListEl.innerHTML = "";
        return;
      }
      emptyStateEl?.classList.add("d-none");
      jobsListEl.innerHTML = filtered.map(toCard).join("");
    }

    function toCard(j) {
      const title   = j.title || "Untitled role";
      const company = j.company || j.employer || "";
      const loc     = j.location || "";
      const url     = j.url || j.apply_url || "#";
      const posted  = j.posted_at || j.posted || j.date || "";
      const when    = posted ? safeDate(posted) : "";
      const remote  = /remote/i.test(loc) || String(j.remote || "").toLowerCase() === "true";

      return `
        <div class="col">
          <a class="text-decoration-none" href="${url}" target="_blank" rel="noopener">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-1">${escapeHtml(title)}</h5>
                <div class="text-muted small mb-2">
                  ${escapeHtml(company)} · ${escapeHtml(loc)} ${remote ? '· <span class="badge text-bg-success">Remote</span>' : ''}
                </div>
                ${when ? <div class="small text-muted">Posted ${when}</div> : ``}
              </div>
            </div>
          </a>
        </div>`;
    }

    function escapeHtml(s="") {
      return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function safeDate(v) {
      const d = new Date(v);
      return isNaN(+d) ? escapeHtml(String(v)) : d.toLocaleDateString();
    }

    // ---------- events (guards prevent “null.addEventListener” errors) ----------
    searchEl?.addEventListener("input", render);
    locEl?.addEventListener("change", render);
    companyEl?.addEventListener("change", render);
    remoteEl?.addEventListener("change", render);
    addBtn?.addEventListener("click", (e) => {/* optional */});

    loadJobs();
  });
  </script>
</body>
</html>