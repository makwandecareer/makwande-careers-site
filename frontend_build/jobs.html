<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AutoApply – Jobs</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="config.js"></script>
</head>
<body onload="requireAuth()">
  <div class="container">
    <nav>
      <h2>Jobs</h2>
      <div>
        <span id="apiStatus" class="badge">Checking API…</span>
        <button style="margin-left:10px" onclick="logout()">Logout</button>
      </div>
    </nav>

    <div class="card">
      <div class="row">
        <input id="q" class="grow" placeholder="Search job title, company, keywords…"/>
        <select id="loc">
          <option value="">Any location</option>
          <option>Remote</option>
          <option>USA</option>
          <option>Europe</option>
          <option>Africa</option>
        </select>
        <button id="searchBtn">Search</button>
      </div>

      <div id="jobs" class="list"></div>
      <p id="empty" style="display:none;margin-top:12px">No jobs found.</p>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
  async function pingAPI() {
    try {
      const r = await api("/health");
      document.getElementById("apiStatus").textContent = r.ok ? "API ✓" : "API error";
    } catch { document.getElementById("apiStatus").textContent = "API offline"; }
  }
  pingAPI();

  function logout(){ clearToken(); location.href="index.html"; }

  const jobsEl = document.getElementById("jobs");
  const emptyEl = document.getElementById("empty");

  async function loadJobs() {
    const q   = document.getElementById("q").value.trim();
    const loc = document.getElementById("loc").value;

    const params = new URLSearchParams();
    if (q) params.set("q", q);
    if (loc) params.set("location", loc);

    const r = await api(/jobs?${params.toString()});
    if (!r.ok) {
      jobsEl.innerHTML = <div class="badge">Failed to load jobs</div>;
      return;
    }

    const items = Array.isArray(r.data?.items) ? r.data.items : (Array.isArray(r.data) ? r.data : []);
    jobsEl.innerHTML = "";
    emptyEl.style.display = items.length ? "none" : "block";

    for (const j of items) {
      const div = document.createElement("div");
      div.className = "job";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <strong>${escapeHtml(j.title || "Untitled")}</strong>
            <div>${escapeHtml(j.company || "")}</div>
            <div class="badge">${escapeHtml(j.location || "Location n/a")}</div>
          </div>
          <div>
            <button data-id="${j.id}">Apply</button>
          </div>
        </div>
      `;
      div.querySelector("button").addEventListener("click", ()=> applyToJob(j.id));
      jobsEl.appendChild(div);
    }
  }

  async function applyToJob(jobId) {
    const r = await api("/applications", { method:"POST", body:{ job_id: jobId }});
    if (r.ok) {
      alert("Application submitted!");
    } else {
      alert(r.data?.detail || "Could not apply");
    }
  }

  function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

  document.getElementById("searchBtn").addEventListener("click", loadJobs);
  loadJobs();
  </script>
</body>
</html>













