<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Point to your API on Render -->
  <script>window.API_ORIGIN = "https://autoapply-api.onrender.com";</script>

  <!-- Favicon (pure green) -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <title>Login • AutoApply</title>

  <style>
    body{background:#f7f9fc}
    .card{max-width:520px;margin:6rem auto;padding:1rem}
    .brand{font-weight:700;letter-spacing:.3px}
    .muted{color:#6c757d}
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom">
    <div class="container">
      <span class="navbar-brand brand">AutoApply</span>
      <small id="api-status" class="muted"></small>
    </div>
  </nav>

  <main class="container">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h3 mb-3 text-center">Welcome back</h1>

        <form id="login-form" autocomplete="on" novalidate>
          <label class="form-label" for="email">Email</label>
          <input id="email" name="email" type="email" class="form-control"
                 autocomplete="email" inputmode="email"
                 autocapitalize="none" spellcheck="false" required />

          <label class="form-label mt-3" for="password">Password</label>
          <input id="password" name="password" type="password" class="form-control"
                 autocomplete="current-password" minlength="6" required />

          <button id="login-btn" class="btn btn-primary w-100 mt-4" type="submit">Log in</button>
          <p id="login-error" class="text-danger small mt-3"></p>
        </form>

        <p class="mt-3 text-center">
          No account? <a href="signup.html">Create one</a>
        </p>
      </div>
    </div>
  </main>

  <!-- Minimal inline SDK (no main.js) -->
  <script>
    (function () {
      const TOKEN_KEY = "AA_TOKEN";

      const ORIGIN = (typeof window.API_ORIGIN === "string" && window.API_ORIGIN) || location.origin;
      const join = (...p) => p.join("/").replace(/(?<!:)\/{2,}/g, "/");
      const API = (path) => join(ORIGIN.replace(/\/$/, ""), "api", path.replace(/^\//, ""));

      const getToken = () => localStorage.getItem(TOKEN_KEY);
      const saveToken = (t) => localStorage.setItem(TOKEN_KEY, t);

      async function tryPaths(paths, options){
        let lastErr;
        for (const p of paths){
          try{
            const res = await fetch(p, options);
            let data = {};
            try { data = await res.json(); } catch {}
            if (!res.ok) {
              const e = new Error(data.detail || data.message || res.statusText);
              e.status = res.status; e.data = data; throw e;
            }
            return data;
          }catch(e){
            lastErr = e;
            if (e.status !== 404) throw e; // only retry on 404
          }
        }
        throw lastErr || new Error("Not Found");
      }

      async function health(){
        try {
          const h = await tryPaths([ join(ORIGIN,"health"), API("health") ], { cache: "no-store" });
          return { ok: !!h.ok, version: h.version };
        } catch { return { ok:false }; }
      }

      async function login(email, password){
        const body = JSON.stringify({ email, password });
        const opts = { method:"POST", headers:{ "Content-Type":"application/json" }, body };
        // Try both canonical and alias routes to avoid 404
        return tryPaths([ API("auth/login"), API("login") ], opts);
      }

      // Paint small badge
      (async () => {
        const el = document.getElementById("api-status");
        if (!el) return;
        const h = await health();
        el.textContent = h.ok ? API connected • v${h.version || "-"} : "API not reachable";
      })();

      // Handle form submit
      const form = document.getElementById("login-form");
      const btn  = document.getElementById("login-btn");
      const err  = document.getElementById("login-error");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        err.textContent = "";
        btn.disabled = true; btn.textContent = "Signing in…";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        try{
          const data = await login(email, password);
          if (!data || !data.access_token) throw new Error(data?.detail || "No token returned");
          saveToken(data.access_token);
          // go to dashboard (adjust if your file is elsewhere)
          location.href = "dashboard.html";
        }catch(ex){
          err.textContent = (ex && ex.message) ? ex.message : "Login failed";
        }finally{
          btn.disabled = false; btn.textContent = "Log in";
        }
      });

      // expose tiny helper if you ever need it
      window.AutoAuth = { getToken };
    })();
  </script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>