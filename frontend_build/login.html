<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Point to your Render API -->
  <meta name="api-origin" content="https://autoapply-api.onrender.com" />

  <title>Login â€¢ AutoApply</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f8fafc }
    .card { max-width: 560px; margin: 6rem auto; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold">AutoApply</a>
    </div>
  </nav>

  <main class="container">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h3 text-center mb-4">Welcome back</h1>

        <div id="alert" class="alert alert-danger d-none" role="alert"></div>

        <!-- SINGLE FORM ONLY -->
        <form id="loginForm" novalidate autocomplete="on">
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input id="email" name="email" type="email" class="form-control" required
                   autocomplete="email" />
          </div>
          <div class="mb-4">
            <label for="password" class="form-label">Password</label>
            <input id="password" name="password" type="password" class="form-control" required
                   autocomplete="current-password" />
          </div>
          <button id="submitBtn" type="submit" class="btn btn-primary w-100">
            Log in
          </button>
        </form>

        <p class="mt-3 text-center">
          No account? <a href="signup.html">Create one</a>
        </p>
      </div>
    </div>
  </main>

  <script>
    (function () {
      // Read API origin from <meta>, or fallback
      var meta = document.querySelector('meta[name="api-origin"]');
      var ORIGIN = meta ? meta.content : (window.API_ORIGIN || location.origin);
    
      function api(p) {
        return ORIGIN.replace(/\/+$/, '') + '/api' + p;
      }
      function token() { return localStorage.getItem('AA_TOKEN'); }
      function saveToken(t) { localStorage.setItem('AA_TOKEN', t); }
      function showErr(msg) {
        var a = document.getElementById('alert');
        if (!a) return;
        a.textContent = msg || 'Something went wrong';
        a.classList.remove('d-none');
      }
    
      // If already logged in, go to dashboard
      if (token()) { window.location.replace('dashboard.html'); return; }
    
      var form = document.getElementById('loginForm');
      if (!form) return;
      form.addEventListener('submit', function (ev) {
        ev.preventDefault(); // stop default submit
    
        var email = (document.getElementById('email') || {}).value || '';
        var password = (document.getElementById('password') || {}).value || '';
        email = email.trim();
    
        if (!email || !password) { showErr('Please enter email and password'); return false; }
    
        var btn = document.getElementById('submitBtn');
        if (btn) btn.disabled = true;
    
        fetch(api('/auth/login'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email, password: password })
        })
          .then(function (res) {
            return res.json().catch(function(){ return {}; }).then(function(data){ return { ok: res.ok, data: data }; });
          })
          .then(function (r) {
            if (!r.ok) throw new Error(r.data.detail || 'Invalid credentials');
            if (!r.data.access_token) throw new Error('No token received');
            saveToken(r.data.access_token);
            window.location.replace('dashboard.html'); // forward after success
          })
          .catch(function (err) {
            showErr(err.message);
            if (btn) btn.disabled = false;
          });
    
        return false;
      });
    })();
    </script>
</body>
</html>