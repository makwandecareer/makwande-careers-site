<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login • AutoApply</title>

  <!-- Favicon (SVG) -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Bootstrap (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <!-- Tell pages where the API lives (Render) -->
  <script>
    window.API_ORIGIN = "https://autoapply-api.onrender.com";
  </script>

  <style>
    body { background:#f8fafc; }
    .auth-card { max-width: 520px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold">AutoApply</a>
      <span id="api-status" class="badge text-bg-warning">Checking API…</span>
    </div>
  </nav>

  <main class="container py-5 d-flex justify-content-center">
    <div class="card shadow-sm auth-card w-100">
      <div class="card-body p-4 p-md-5">
        <h1 class="h3 mb-4 text-center">Welcome back</h1>

        <!-- LOGIN FORM -->
        <form id="loginForm" method="post" action="#">
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input
              id="email"
              name="email"
              type="email"
              class="form-control"
              required
              autocomplete="email"
              inputmode="email"
            />
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input
              id="password"
              name="password"
              type="password"
              class="form-control"
              required
              autocomplete="current-password"
            />
          </div>

          <button id="loginBtn" type="submit" class="btn btn-primary w-100">
            Log in
          </button>

          <div id="loginError" class="text-danger small mt-3" role="alert" aria-live="polite"></div>

          <p class="text-center mt-4 mb-0">
            No account? <a href="signup.html">Create one</a>
          </p>
        </form>
      </div>
    </div>
  </main>

  <!-- Bootstrap bundle (CDN) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Minimal auth JS (inline to keep it simple) -->
  <script>
    (function () {
      const TOKEN_KEY = "autoapply_token";
      const API_BASE = (window.API_ORIGIN || "").replace(/\/$/, "") + "/api";

      const $ = (id) => document.getElementById(id);
      const saveToken = (t) => localStorage.setItem(TOKEN_KEY, t);

      // Health badge
      async function paintBadge() {
        const badge = $("api-status");
        if (!badge) return;
        try {
          const res = await fetch(API_BASE + "/health", { cache: "no-store" });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data && (data.ok === true || data.service)) {
            badge.className = "badge text-bg-success";
            badge.textContent = API connected • v${data.version || "-"};
          } else {
            throw new Error();
          }
        } catch {
          // fallback to /health without /api
          try {
            const h = await fetch((window.API_ORIGIN || "").replace(/\/$/, "") + "/health", { cache: "no-store" });
            const d = await h.json().catch(() => ({}));
            if (h.ok) {
              $("api-status").className = "badge text-bg-success";
              $("api-status").textContent = API connected • v${d.version || "-"};
              return;
            }
          } catch {}
          badge.className = "badge text-bg-danger";
          badge.textContent = "API not reachable";
        }
      }

      async function handleLogin(evt) {
        evt.preventDefault();
        const email = ($("email").value || "").trim();
        const password = ($("password").value || "");

        $("loginError").textContent = "";
        $("loginBtn").disabled = true;

        try {
          const res = await fetch(API_BASE + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            $("loginError").textContent = data.detail || "Invalid email or password.";
            return;
          }
          if (!data.access_token) {
            $("loginError").textContent = "Login succeeded but no token was returned.";
            return;
          }

          saveToken(data.access_token);
          // Go to dashboard after successful login
          window.location.href = "dashboard.html";
        } catch (e) {
          $("loginError").textContent = "Network error. Please try again.";
        } finally {
          $("loginBtn").disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        $("loginForm").addEventListener("submit", handleLogin);
        paintBadge();
      });
    })();
  </script>
</body>
</html>