<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Makwande Careers - Jobs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .job-card { transition: box-shadow .2s ease; }
    .job-card:hover { box-shadow: 0 10px 24px rgba(0,0,0,.08); }
  </style>
</head>
<body>
<header class="bg-white border-bottom">
  <div class="container d-flex align-items-center justify-content-between py-3">
    <a class="navbar-brand fw-bold text-decoration-none" href="index.html">Makwande Careers</a>
    <nav class="d-flex gap-3">
      <a class="text-decoration-none" href="jobs.html">Jobs</a>
      <a class="text-decoration-none" href="revamp.html">CV Revamp</a>
      <a class="text-decoration-none" href="dashboard.html">Dashboard</a>
      <a class="btn btn-primary" href="login.html">Login</a>
    </nav>
  </div>
</header>

<section class="py-4">
  <div class="container">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label">Search</label>
            <input id="searchInput" class="form-control" placeholder="Title, company, keyword...">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Location</label>
            <select id="locationFilter" class="form-select"><option value="">All</option></select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Company</label>
            <select id="companyFilter" class="form-select"><option value="">All</option></select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label d-block">Remote</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="remoteOnly">
              <label class="form-check-label" for="remoteOnly">Remote only</label>
            </div>
          </div>
          <div class="col-12 d-flex gap-2 justify-content-end">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addJobModal">+ Add Job</button>
          </div>
          <div class="col-12 d-flex justify-content-between">
            <small class="text-muted">Jobs sync daily from Snowflake (via GitHub scraper).</small>
            <small id="lastUpdated" class="text-muted"></small>
          </div>
        </div>
      </div>
    </div>

    <div id="jobsList" class="row g-3"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <p class="mb-2">No jobs found.</p>
      <p class="small">Try clearing filters.</p>
    </div>
  </div>
</section>

<!-- Add Job Modal (posts to backend; also updates the list immediately) -->
<div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="addJobForm">
        <div class="modal-header">
          <h5 class="modal-title">Add a Job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Job Title *</label><input required name="title" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Company *</label><input required name="company" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Location *</label><input required name="location" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Country</label><input name="country" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Closing Date</label><input type="date" name="closing_date" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Apply URL *</label><input required type="url" name="apply_url" class="form-control"></div>
            <div class="col-12"><label class="form-label">Description *</label><textarea required name="description" rows="5" class="form-control"></textarea></div>
            <div class="col-12"><div class="form-check"><input class="form-check-input" type="checkbox" name="remote" id="remoteInput"><label class="form-check-label" for="remoteInput">Remote role</label></div></div>
            <div class="col-12"><input id="apiKey" class="form-control" placeholder="X-API-Key (optional)"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Job</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ======= CONFIG =======
  // Set to your Render backend URL (custom domain or onrender.com):
  const API_BASE = "https://YOUR-BACKEND.onrender.com";

  // ======= helpers =======
  const $ = s => document.querySelector(s);
  const jobsListEl = $("#jobsList"), emptyStateEl = $("#emptyState");
  const locationFilter = $("#locationFilter"), companyFilter = $("#companyFilter");
  const remoteOnly = $("#remoteOnly"), searchInput = $("#searchInput");
  const lastUpdated = $("#lastUpdated");

  let JOBS = [];

  function unique(list, key) { return [...new Set(list.map(x => (x[key]||"").trim()).filter(Boolean))].sort(); }
  function renderFilters(list) {
    locationFilter.innerHTML = `<option value="">All</option>` + unique(list,"location").map(v=>`<option>${v}</option>`).join("");
    companyFilter.innerHTML = `<option value="">All</option>` + unique(list,"company").map(v=>`<option>${v}</option>`).join("");
  }
  function esc(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
  function matches(job){
    const q = searchInput.value.toLowerCase().trim();
    const loc = locationFilter.value, comp = companyFilter.value, remote = remoteOnly.checked;
    if (q) {
      const hay = `${job.title} ${job.company} ${job.location} ${job.country} ${job.description}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (loc && job.location !== loc) return false;
    if (comp && job.company !== comp) return false;
    if (remote && !job.remote) return false;
    return true;
  }
  function renderJobs() {
    const list = JOBS.filter(matches);
    jobsListEl.innerHTML = "";
    if (!list.length) { emptyStateEl.classList.remove("d-none"); return; }
    emptyStateEl.classList.add("d-none");
    for (const job of list) {
      const badge = job.remote ? `<span class="badge text-bg-success ms-2">Remote</span>` : "";
      const closing = job.closing_date ? `<span class="small text-muted"> • Closes ${esc(job.closing_date)}</span>` : "";
      const card = document.createElement("div");
      card.className = "col-12";
      card.innerHTML = `
        <div class="card job-card border-0 shadow-sm">
          <div class="card-body d-flex flex-column flex-md-row justify-content-between">
            <div class="me-3">
              <h5 class="mb-1">${esc(job.title)} ${badge}</h5>
              <div class="text-muted mb-2">${esc(job.company)} • ${esc(job.location)}${closing}</div>
              <p class="mb-0">${esc(job.description).slice(0,220)}${job.description.length>220?"…":""}</p>
            </div>
            <div class="text-md-end mt-3 mt-md-0">
              <a class="btn btn-primary" target="_blank" rel="noopener" href="${esc(job.apply_url)}">Apply</a>
            </div>
          </div>
        </div>`;
      jobsListEl.appendChild(card);
    }
  }
  [searchInput, locationFilter, companyFilter, remoteOnly].forEach(el => el.addEventListener("input", renderJobs));

  async function loadJobs() {
    const res = await fetch(`${API_BASE.replace(/\/$/,"")}/api/jobs?limit=1000`);
    if (!res.ok) throw new Error("API "+res.status);
    JOBS = await res.json();
    renderFilters(JOBS);
    renderJobs();
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();
  }

  // Add Job -> POST to backend then refresh list
  document.getElementById("addJobForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const job = {
      id: crypto.randomUUID(),
      title: String(fd.get("title")||"").trim(),
      company: String(fd.get("company")||"").trim(),
      location: String(fd.get("location")||"").trim(),
      country: String(fd.get("country")||"").trim(),
      remote: !!fd.get("remote"),
      closing_date: String(fd.get("closing_date")||"").trim(),
      apply_url: String(fd.get("apply_url")||"").trim(),
      description: String(fd.get("description")||"").trim(),
      posted_at: new Date().toISOString()
    };
    const headers = {"Content-Type":"application/json"};
    const apiKey = document.getElementById("apiKey").value.trim();
    if (apiKey) headers["X-API-Key"] = apiKey;

    await fetch(`${API_BASE.replace(/\/$/,"")}/api/jobs`, {method:"POST", headers, body: JSON.stringify(job)});
    await loadJobs();

    const modalEl = document.getElementById('addJobModal');
    bootstrap.Modal.getInstance(modalEl).hide();
    e.target.reset();
  });

  document.addEventListener("DOMContentLoaded", loadJobs);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
