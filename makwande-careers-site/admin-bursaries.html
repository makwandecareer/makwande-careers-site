<!DOCTYPE html>
<html lang="en">
  <main>
    <div class="container">
      <!-- PAGE TITLE -->
      <h1 class="section-title display-6 mb-3">Find your next role</h1>
      <p class="lead mb-4">Filter by country, company, and match score. Click a role to view & apply.</p>
  
      <!-- your filters / table / cards go here -->
    </div>
  </main>
  
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin · Bursaries — Makwande Careers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/app.css"/>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Makwande Careers — Admin</a>
    <button class="btn btn-outline-light btn-sm" id="setApi">API</button>
    <button class="btn btn-outline-warning btn-sm ms-2" id="setToken">Token</button>
  </div>
</nav>

<section class="py-4">
  <div class="container">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Add / Edit Bursary</h5>
            <form id="form" class="row g-2">
              <div class="col-12">
                <label class="form-label">ID (unique)</label>
                <input class="form-control" id="id" placeholder="e.g. bsa-004" required />
              </div>
              <div class="col-12">
                <label class="form-label">Title</label>
                <input class="form-control" id="title" required />
              </div>
              <div class="col-12">
                <label class="form-label">Provider</label>
                <input class="form-control" id="provider" required />
              </div>
              <div class="col-6">
                <label class="form-label">Country</label>
                <input class="form-control" id="country" required />
              </div>
              <div class="col-6">
                <label class="form-label">Field</label>
                <input class="form-control" id="field_of_study" required />
              </div>
              <div class="col-6">
                <label class="form-label">Amount (R)</label>
                <input class="form-control" type="number" id="amount" min="0" required />
              </div>
              <div class="col-6">
                <label class="form-label">Deadline (YYYY-MM-DD)</label>
                <input class="form-control" id="deadline" placeholder="2025-09-30" required />
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="4" required></textarea>
              </div>
              <div class="col-12 d-grid gap-2">
                <button class="btn btn-primary" id="createBtn" type="submit">Create</button>
                <button class="btn btn-warning" id="updateBtn" type="button">Update</button>
                <button class="btn btn-secondary" id="resetBtn" type="button">Reset</button>
              </div>
              <div id="msg" class="small text-muted mt-2"></div>
            </form>
          </div>
        </div>
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <h6 class="card-title">Applications (latest)</h6>
            <div class="input-group mb-2">
              <input id="appEmail" class="form-control" placeholder="Filter by email (optional)" />
              <button class="btn btn-outline-secondary" id="loadApps">Load</button>
            </div>
            <div class="table-responsive" style="max-height:300px; overflow:auto;">
              <table class="table table-sm">
                <thead><tr><th>When</th><th>Name</th><th>Bursary</th><th>Status</th></tr></thead>
                <tbody id="appsTbody"><tr><td colspan="4" class="text-muted">—</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Bursaries</h5>
              <span class="text-muted small" id="count"></span>
            </div>
            <div class="table-responsive mt-2">
              <table class="table align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th><th>Title</th><th>Provider</th><th>Country</th>
                    <th>Field</th><th>Amount</th><th>Deadline</th><th></th>
                  </tr>
                </thead>
                <tbody id="tbody"><tr><td colspan="8" class="text-muted">Loading…</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<footer class="bg-dark text-light text-center py-3">
  <small>&copy; <span id="year"></span> Makwande Careers — Admin</small>
</footer>

<script>
const API_DEFAULT = "http://127.0.0.1:8000";
const getApi = () => localStorage.getItem("API_BASE") || API_DEFAULT;
const setApi = (u) => localStorage.setItem("API_BASE", u);
const getTok = () => localStorage.getItem("ADMIN_TOKEN") || "";
const setTok = (t) => localStorage.setItem("ADMIN_TOKEN", t);
const $ = (id) => document.getElementById(id);
$("year").textContent = new Date().getFullYear();

$("setApi").onclick = () => {
  const next = prompt("Set API base", getApi());
  if (next) { setApi(next); location.reload(); }
};
$("setToken").onclick = () => {
  const next = prompt("Set ADMIN token", getTok());
  if (next) { setTok(next); alert("Saved"); }
};

async function j(url, opts={}) {
  const res = await fetch(url, {
    headers: { "Content-Type":"application/json", "X-Admin-Token": getTok() },
    ...opts
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function fillForm(b) {
  $("id").value = b.id; $("title").value = b.title; $("provider").value = b.provider;
  $("country").value = b.country; $("field_of_study").value = b.field_of_study;
  $("amount").value = b.amount; $("deadline").value = b.deadline;
  $("description").value = b.description || "";
}

function clearForm() { $("form").reset(); $("msg").textContent = ""; }

async function loadAll() {
  $("tbody").innerHTML = `<tr><td colspan="8" class="text-muted">Loading…</td></tr>`;
  try {
    const rows = await j(`${getApi()}/api/admin/bursaries`);
    $("tbody").innerHTML = rows.map(b => `
      <tr>
        <td class="text-muted small">${b.id}</td>
        <td class="fw-semibold">${b.title}</td>
        <td>${b.provider}</td>
        <td><span class="badge bg-info-subtle text-info-emphasis">${b.country}</span></td>
        <td><span class="badge bg-secondary-subtle text-secondary-emphasis">${b.field_of_study}</span></td>
        <td>R${Number(b.amount).toLocaleString()}</td>
        <td><span class="badge bg-warning-subtle text-warning-emphasis">${b.deadline}</span></td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-primary me-1" data-edit="${b.id}">Edit</button>
          <button class="btn btn-sm btn-outline-danger" data-del="${b.id}">Delete</button>
        </td>
      </tr>
    `).join("");
    $("count").textContent = `${rows.length} total`;
  } catch (e) {
    $("tbody").innerHTML = `<tr><td colspan="8" class="text-danger">Auth failed or server error.</td></tr>`;
  }
}

document.addEventListener("click", async (e) => {
  const editBtn = e.target.closest("[data-edit]");
  const delBtn  = e.target.closest("[data-del]");
  if (editBtn) {
    const id = editBtn.getAttribute("data-edit");
    const rows = await j(`${getApi()}/api/admin/bursaries`);
    const match = rows.find(r => r.id === id);
    if (match) fillForm(match);
  }
  if (delBtn) {
    const id = delBtn.getAttribute("data-del");
    if (!confirm(`Delete ${id}?`)) return;
    try {
      await j(`${getApi()}/api/admin/bursaries/${encodeURIComponent(id)}`, { method:"DELETE" });
      await loadAll();
    } catch (e) { alert("Delete failed: " + e.message); }
  }
});

$("form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    id: $("id").value.trim(),
    title: $("title").value.trim(),
    provider: $("provider").value.trim(),
    country: $("country").value.trim(),
    field_of_study: $("field_of_study").value.trim(),
    amount: Number($("amount").value || 0),
    deadline: $("deadline").value.trim(),
    description: $("description").value.trim(),
  };
  $("msg").textContent = "Creating…";
  try {
    await j(`${getApi()}/api/admin/bursaries`, { method:"POST", body: JSON.stringify(payload) });
    $("msg").textContent = "Created ✔";
    await loadAll();
  } catch (e) {
    $("msg").textContent = "Create failed: " + e.message;
  }
});

$("updateBtn").onclick = async () => {
  const id = $("id").value.trim();
  if (!id) return alert("ID required for update");
  const payload = {};
  ["title","provider","country","field_of_study","amount","deadline","description"].forEach(k => {
    const v = $(k).value;
    if (v !== "") payload[k] = k === "amount" ? Number(v) : v;
  });
  $("msg").textContent = "Updating…";
  try {
    await j(`${getApi()}/api/admin/bursaries/${encodeURIComponent(id)}`, { method:"PUT", body: JSON.stringify(payload) });
    $("msg").textContent = "Updated ✔";
    await loadAll();
  } catch (e) { $("msg").textContent = "Update failed: " + e.message; }
};

$("resetBtn").onclick = clearForm;

$("loadApps").onclick = async () => {
  const email = $("appEmail").value.trim();
  const url = email ? `${getApi()}/api/admin/applications?email=${encodeURIComponent(email)}` : `${getApi()}/api/admin/applications`;
  $("appsTbody").innerHTML = `<tr><td colspan="4" class="text-muted">Loading…</td></tr>`;
  try {
    const rows = await j(url);
    $("appsTbody").innerHTML = rows.map(r => `
      <tr>
        <td class="small text-muted">${r.submitted_at}</td>
        <td>${r.full_name}</td>
        <td>${r.bursary_title}</td>
        <td><span class="badge bg-info">${r.status}</span></td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="text-muted">No applications.</td></tr>`;
  } catch (e) {
    $("appsTbody").innerHTML = `<tr><td colspan="4" class="text-danger">Failed: ${e.message}</td></tr>`;
  }
};

// init
(async () => {
  if (!getTok()) setTok(prompt("Enter ADMIN token") || "");
  await loadAll();
})();
</script>
</body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Makwande Careers</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="jobs.html">Jobs</a></li>
        <li class="nav-item"><a class="nav-link" href="bursaries.html">Bursaries</a></li>
        <li class="nav-item"><a class="nav-link" href="universities.html">Universities</a></li>
        <li class="nav-item"><a class="nav-link" href="recruiters.html">Recruiters</a></li>
        <li class="nav-item"><a class="nav-link" href="employers.html">Employers</a></li>
        <li class="nav-item"><a class="nav-link" href="investors.html">Investors</a></li>
        <li class="nav-item ms-lg-2"><a class="btn btn-primary" href="signup.html">Get Started</a></li>
      </ul>
    </div>
  </div>
</nav>
<footer class="py-5 mt-5">
  <div class="container text-center">
    <p class="mb-1">&copy; <span id="year"></span> Makwande Careers. All rights reserved.</p>
    <small>
      <a href="partnerships.html">Partnerships</a> ·
      <a href="investors.html">Investors</a> ·
      <a href="collaborations.html">Brand Collaborations</a>
    </small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  // One-time: set backend URL for all pages
  (function(){
    var url = "https://autoapplyapp.onrender.com"; // <-- your backend URL
    ["API_BASE","apiBase"].forEach(function(k){ if(!localStorage.getItem(k)) localStorage.setItem(k, url); });
  })();
</script>
</html>
<footer class="py-5 mt-5">
  <div class="container text-center">
    <p class="mb-1">&copy; <span id="year"></span> Makwande Careers. All rights reserved.</p>
    <small>
      <a href="partnerships.html">Partnerships</a> ·
      <a href="investors.html">Investors</a> ·
      <a href="collaborations.html">Brand Collaborations</a>
    </small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  // One-time: set backend URL for all pages
  (function(){
    var url = "https://autoapplyapp.onrender.com"; // <-- your backend URL
    ["API_BASE","apiBase"].forEach(function(k){ if(!localStorage.getItem(k)) localStorage.setItem(k, url); });
  })();
</script>
