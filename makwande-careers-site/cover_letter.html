<!DOCTYPE html>
<html lang="en">
  <script>
    // FastAPI backend (Render)
    const API_BASE = "https://autoapplyapp.onrender.com";
  </script>  
<head>
  <meta charset="UTF-8" />
  <title>Cover Letter | Makwande Careers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- App & Bootstrap CSS -->
  <link rel="stylesheet" href="assets/css/app.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg fixed-top bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">Makwande Careers</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navMain" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="jobs.html" class="nav-link">Jobs</a></li>
          <li class="nav-item"><a href="cv-revamp.html" class="nav-link">CV Revamp</a></li>
          <li class="nav-item"><a href="cover-letter.html" class="nav-link active">Cover Letter</a></li>
          <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container" style="margin-top: 5.5rem;">
    <header class="mb-4">
      <h2 class="mb-1">AI-Powered Cover Letter</h2>
      <p class="lead mb-0">Paste your CV and the job description. We’ll generate a tailored, ATS-friendly cover letter.</p>
    </header>

    <!-- Alerts -->
    <div id="alertBox" class="d-none"></div>

    <!-- Cover Letter Form -->
    <form id="coverLetterForm" class="card shadow-sm border-0 p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="applicant_name" class="form-label">Your Name</label>
          <input type="text" class="form-control" id="applicant_name" placeholder="e.g., Makwande Gcora" required />
        </div>
        <div class="col-md-6">
          <label for="role" class="form-label">Job Role</label>
          <input type="text" class="form-control" id="role" placeholder="e.g., Process Engineer" required />
        </div>
        <div class="col-md-6">
          <label for="company" class="form-label">Company</label>
          <input type="text" class="form-control" id="company" placeholder="e.g., Progressive Liquor" required />
        </div>
        <div class="col-md-6">
          <label for="tone" class="form-label">Tone</label>
          <select id="tone" class="form-select">
            <option value="professional" selected>Professional</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="concise">Concise</option>
            <option value="warm">Warm</option>
          </select>
        </div>

        <div class="col-12">
          <label for="cl_job_description" class="form-label">Job Description</label>
          <textarea id="cl_job_description" class="form-control" rows="6" placeholder="Paste the job description here..." required></textarea>
        </div>

        <div class="col-12">
          <label for="cl_cv_text" class="form-label">Your CV (Plain Text)</label>
          <textarea id="cl_cv_text" class="form-control" rows="10" placeholder="Paste your CV text here..." required></textarea>
          <div class="form-text">Tip: Paste plain text. If you have a PDF/DOCX, convert/extract to text first.</div>
        </div>
      </div>

      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-success btn-lg">Generate Cover Letter</button>
      </div>
    </form>

    <!-- Results -->
    <section id="coverLetterResults" class="mt-4 d-none">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h4 class="mb-0">Your Cover Letter</h4>
            <button id="copyBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
          </div>
          <hr />
          <pre id="cover_letter_output" class="mb-0" style="white-space:pre-wrap; font-family:inherit;"></pre>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-light text-center py-4 mt-5">
    <div class="container">
      <p class="mb-1">&copy; <span id="year"></span> Makwande Careers. All rights reserved.</p>
      <p class="small mb-0">Empowering Africa’s professionals with smarter job applications, bursaries, and career growth.</p>
    </div>
  </footer>

  <!-- Bootstrap JS (optional for navbar toggle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
    // ----------------- CONFIG -----------------
    // FastAPI backend (Render)
    const API_BASE = "https://autoapplyapp.onrender.com";

    // ----------------- HELPERS ----------------
    function showAlert(type, msg) {
      const box = document.getElementById("alertBox");
      box.className = `alert alert-${type}`;
      box.textContent = msg;
      box.classList.remove("d-none");
    }
    function hideAlert() {
      const box = document.getElementById("alertBox");
      box.className = "d-none";
      box.textContent = "";
    }
    async function postJSON(path, payload) {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.detail || `HTTP ${res.status}`);
      return data;
    }
    function setYear() {
      document.getElementById("year").textContent = new Date().getFullYear();
    }

    // ----------------- FORM HOOKUP ------------
    document.addEventListener("DOMContentLoaded", () => {
      setYear();

      const form = document.getElementById("coverLetterForm");
      const output = document.getElementById("cover_letter_output");
      const results = document.getElementById("coverLetterResults");
      const copyBtn = document.getElementById("copyBtn");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert();

        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Generating…";

        const payload = {
          applicant_name: document.getElementById("applicant_name").value.trim(),
          company: document.getElementById("company").value.trim(),
          role: document.getElementById("role").value.trim(),
          job_description: document.getElementById("cl_job_description").value.trim(),
          cv_text: document.getElementById("cl_cv_text").value.trim(),
          tone: document.getElementById("tone").value
        };

        // Basic client-side validation
        if (!payload.applicant_name || !payload.company || !payload.role || !payload.job_description || !payload.cv_text) {
          showAlert("warning", "Please fill in all required fields.");
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        try {
          const data = await postJSON("/api/cover_letter", payload);
          output.textContent = data?.letter_markdown || "(No content returned.)";
          results.classList.remove("d-none");
        } catch (err) {
          showAlert("danger", `Cover letter failed: ${err.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(output.textContent);
          showAlert("success", "Cover letter copied to clipboard.");
          setTimeout(hideAlert, 2000);
        } catch {
          showAlert("warning", "Could not copy. Please select and copy manually.");
          setTimeout(hideAlert, 2000);
        }
      });
    });
  </script>
</body>
</html>
