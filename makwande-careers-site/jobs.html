<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobs – Makwande Careers</title>
  <style>
    :root { --bg:#0f1b2d; --panel:#13233a; --text:#e8f1ff; --muted:#a9b7c6; --brand:#28c291; --pill:#0d3342; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{padding:24px 16px;text-align:center}
    header h1{margin:0;font-size:26px;letter-spacing:.3px}
    header p{margin:6px 0 0;color:var(--muted)}
    .wrap{max-width:1000px;margin:0 auto;padding:12px 16px 48px}
    .controls{display:grid;grid-template-columns:1fr 1fr auto auto auto;gap:12px;background:var(--panel);padding:14px;border-radius:14px}
    select,input,button{height:40px;border:1px solid #24415f;background:#0f2536;color:var(--text);border-radius:10px;padding:0 12px}
    button{background:var(--brand);color:#06291e;border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#1f3a57;color:var(--text)}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .jobs{margin-top:16px;display:grid;gap:10px}
    .card{background:var(--panel);border-radius:16px;padding:14px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .card h3{margin:0;font-size:16px}
    .card .meta{color:var(--muted);font-size:13px}
    .pill{background:var(--pill);padding:4px 8px;border-radius:999px;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{text-align:right}
    .footer{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .error{background:#3a1420;border:1px solid #7e1d2e;color:#ffd9df;padding:10px;border-radius:12px}
    @media (max-width:760px){
      .controls{grid-template-columns:1fr 1fr 1fr}
      .right{grid-column:1/-1;text-align:left}
    }
  </style>
</head>
<body>
  <header>
    <h1>Makwande Careers</h1>
    <p>Fresh roles across the SADC region.</p>
  </header>

  <div class="wrap">
    <div class="controls">
      <label>
        <div>Country</div>
        <select id="country">
          <option value="">All SADC</option>
          <option value="ZA">South Africa (ZA)</option>
          <option value="BW">Botswana (BW)</option>
          <option value="NA">Namibia (NA)</option>
          <option value="ZM">Zambia (ZM)</option>
          <option value="ZW">Zimbabwe (ZW)</option>
          <option value="MZ">Mozambique (MZ)</option>
          <option value="AO">Angola (AO)</option>
          <option value="TZ">Tanzania (TZ)</option>
          <option value="MW">Malawi (MW)</option>
          <option value="LS">Lesotho (LS)</option>
        </select>
      </label>

      <label>
        <div>Search</div>
        <input id="q" placeholder="e.g. data, finance, graduate" />
      </label>

      <label>
        <div>Limit</div>
        <select id="limit">
          <option>20</option><option>50</option><option>100</option>
        </select>
      </label>

      <div class="row">
        <button id="load">Load Jobs</button>
        <button class="secondary" id="reset">Reset</button>
      </div>

      <div class="right">
        <div class="hint" id="status">Idle</div>
      </div>
    </div>

    <div id="alert" class="error" style="display:none"></div>
    <div id="list" class="jobs"></div>

    <div class="footer">
      <button id="prev" class="secondary">Prev</button>
      <span id="page" class="pill">1</span>
      <button id="next" class="secondary">Next</button>
    </div>
  </div>

<script>
(() => {
  // Prefer env from config.js, fall back to default
const API_BASE = (window.CONFIG && window.CONFIG.API_BASE) || 'https://autoapplyapp.onrender.com';

// If you later want to pin the path as well (instead of auto-detect)
// add to config.js: API_PATH: "/api/jobs"
// and then set: const CANDIDATES = [window.CONFIG?.API_PATH || '/api/jobs', '/jobs', '/v1/jobs', '/api/v1/jobs'];
  // likely paths in your FastAPI app
  const CANDIDATES = ['/api/jobs','/jobs','/v1/jobs','/api/v1/jobs'];

  const $ = sel => document.querySelector(sel);
  const countryEl = $('#country');
  const qEl = $('#q');
  const limitEl = $('#limit');
  const listEl = $('#list');
  const pageEl = $('#page');
  const statusEl = $('#status');
  const alertEl = $('#alert');

  let page = 1;
  let apiPath = localStorage.getItem('jobsApiPath') || '';

  function showAlert(msg){
    alertEl.style.display='block';
    alertEl.textContent = msg;
  }
  function clearAlert(){ alertEl.style.display='none'; }

  async function detectApiPath() {
    // if we already have a cached path, trust it but verify once
    const toTry = apiPath ? [apiPath, ...CANDIDATES.filter(p => p !== apiPath)] : [...CANDIDATES];
    for (const p of toTry) {
      try {
        const url = new URL(API_BASE + p);
        url.searchParams.set('limit','1');
        const r = await fetch(url.toString(), { headers: { 'accept':'application/json' }});
        if (!r.ok) continue;
        const j = await r.json().catch(()=> ({}));
        // accept either an array, or an object with common keys
        const ok = Array.isArray(j)
               || Array.isArray(j.items)
               || Array.isArray(j.results)
               || Array.isArray(j.data);
        if (ok) {
          localStorage.setItem('jobsApiPath', p);
          apiPath = p;
          console.log('[jobs] using API path:', p);
          return p;
        }
      } catch (e) { /* try next */ }
    }
    throw new Error('Could not find a working jobs endpoint on the API.');
  }

  function jobArray(payload){
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.items)) return payload.items;
    if (Array.isArray(payload.results)) return payload.results;
    if (Array.isArray(payload.data)) return payload.data;
    return [];
  }

  function fmtDate(s){
    if (!s) return '';
    try { return new Date(s).toLocaleDateString(); } catch { return s; }
  }

  function render(jobs){
    listEl.innerHTML = '';
    if (!jobs.length){
      listEl.innerHTML = <div class="hint">No jobs for these filters yet. Try another country or clear the search.</div>;
      return;
    }
    const frag = document.createDocumentFragment();
    for (const j of jobs){
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div>
          <h3>${escapeHtml(j.title || 'Untitled')}</h3>
          <div class="meta">${escapeHtml(j.company || 'Unknown')} · ${escapeHtml(j.location || j.country_name || '')}</div>
          <div class="row" style="margin-top:6px">
            ${j.source ? <span class="pill">Source: ${escapeHtml(j.source)}</span> : ''}
            ${j.match != null ? <span class="pill">Match: ${Number(j.match).toFixed(0)}%</span> : ''}
            ${j.posted_at ? <span class="pill">Posted: ${fmtDate(j.posted_at)}</span> : ''}
          </div>
        </div>
        <div class="right">
          <a target="_blank" rel="noopener" href="${escapeUrl(j.url)}">
            <button>View</button>
          </a>
        </div>`;
      frag.appendChild(card);
    }
    listEl.appendChild(frag);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeUrl(u){
    try { return new URL(u).toString(); } catch { return '#'; }
  }

  async function load() {
    clearAlert();
    statusEl.textContent = 'Detecting API…';
    try {
      const path = await detectApiPath();
      statusEl.textContent = 'Loading…';

      const url = new URL(API_BASE + path);
      const limit = Number(limitEl.value || 20);
      const offset = (page - 1) * limit;
      url.searchParams.set('limit', String(limit));
      url.searchParams.set('offset', String(offset));

      const cc = countryEl.value.trim();
      if (cc) url.searchParams.set('country', cc);

      const q = qEl.value.trim();
      if (q) url.searchParams.set('q', q);

      const r = await fetch(url.toString(), { headers: { 'accept':'application/json' }});
      if (!r.ok){
        const txt = await r.text();
        throw new Error(HTTP ${r.status} – ${txt.slice(0,200)});
      }
      const payload = await r.json();
      const items = jobArray(payload);
      render(items);
      statusEl.textContent = Loaded ${items.length} job(s).;
    } catch (e){
      console.error(e);
      showAlert (Couldn't load jobs: ${e.message});
      statusEl.textContent = 'Error';
    }
  }

  $('#load').addEventListener('click', () => { page = 1; pageEl.textContent = page; load(); });
  $('#reset').addEventListener('click', () => { qEl.value=''; countryEl.value=''; page=1; pageEl.textContent=page; load(); });
  $('#prev').addEventListener('click', () => { if (page>1){ page--; pageEl.textContent=page; load(); }});
  $('#next').addEventListener('click', () => { page++; pageEl.textContent=page; load(); });

  // auto-load on first paint
  load();
})();
</script>
</body>
<!-- in <head> (anywhere before your main <script>) -->
<script src="./config.js"></script>
</html>