<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobs – Makwande Careers</title>
  <meta name="description" content="Fresh roles across the SADC region." />
  <style>
    :root{
      --bg:#0b2136; --card:#0f2c49; --muted:#9fb3c8; --text:#e7f1fb; --accent:#23d18b; --chip:#183a5c;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:20px 16px 0;max-width:1100px;margin:0 auto}
    .brand{font-weight:800;font-size:clamp(26px,4vw,44px);letter-spacing:.3px;margin:0}
    .tag{color:var(--muted);margin:.25rem 0 1.25rem}
    .panel{background:var(--card);border-radius:var(--radius);padding:14px;display:grid;gap:12px;
           grid-template-columns:1fr;max-width:1100px;margin:0 auto}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .ctrl{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
    label{font-size:.85rem;color:var(--muted)}
    input,select,button{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #234560;background:#0b243d;color:var(--text);
      outline:none
    }
    input::placeholder{color:#7d98b3}
    button{background:var(--accent);color:#0a1d2f;font-weight:700;border:none;cursor:pointer}
    button.secondary{background:#0b243d;color:var(--muted);border:1px solid #234560}
    button:disabled{opacity:.55;cursor:not-allowed}
    .results{max-width:1100px;margin:16px auto 80px;display:grid;gap:14px}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;display:grid;gap:6px}
    .title{font-size:1.05rem;font-weight:700}
    .title a{color:#cfe8ff;text-decoration:none}
    .title a:hover{text-decoration:underline}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:.9rem}
    .chip{background:var(--chip);padding:4px 10px;border-radius:999px;color:#cfe8ff;font-size:.8rem}
    .grid{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .right{display:flex;gap:10px;align-items:center}
    .pct{font-weight:800;color:var(--accent)}
    .status{max-width:1100px;margin:10px auto 0;color:var(--muted);font-size:.95rem}
    .pager{max-width:1100px;margin:8px auto 40px;display:flex;align-items:center;gap:10px}
    .pager button{width:auto;min-width:90px}
    .count{color:var(--muted)}
    @media(min-width:780px){
      .panel{grid-template-columns:1.5fr 2fr .8fr auto auto}
      .ctrl{flex:initial}
    }
  </style>
</head>
<body>
  <header>
    <h1 class="brand">Makwande Careers</h1>
    <p class="tag">Fresh roles across the SADC region.</p>
  </header>

  <section class="panel" role="search">
    <div class="ctrl">
      <label for="country">Country</label>
      <select id="country">
        <option value="">All SADC</option>
        <option value="ZA">South Africa</option>
        <option value="BW">Botswana</option>
        <option value="NA">Namibia</option>
        <option value="ZW">Zimbabwe</option>
        <option value="ZM">Zambia</option>
        <option value="LS">Lesotho</option>
        <option value="SZ">Eswatini</option>
        <option value="MZ">Mozambique</option>
        <option value="AO">Angola</option>
        <option value="MW">Malawi</option>
      </select>
    </div>

    <div class="ctrl">
      <label for="q">Search</label>
      <input id="q" placeholder="e.g. data, finance, grad…"/>
    </div>

    <div class="ctrl">
      <label for="limit">Limit</label>
      <select id="limit">
        <option>10</option>
        <option selected>20</option>
        <option>50</option>
        <option>100</option>
      </select>
    </div>

    <div class="ctrl">
      <label>&nbsp;</label>
      <button id="loadBtn">Load Jobs</button>
    </div>

    <div class="ctrl">
      <label>&nbsp;</label>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>
  </section>

  <div class="status" id="status">Ready.</div>

  <section class="pager">
    <button id="prevBtn" class="secondary" disabled>Prev</button>
    <span class="count">Page <span id="pageNum">1</span></span>
    <button id="nextBtn" class="secondary" disabled>Next</button>
  </section>

  <section class="results" id="results" aria-live="polite"></section>

  <script>
    // -------- Config (API base from site-config.json with fallback) ----------
    var API_BASE = "https://autoapplyapp.onrender.com";
    (function bootstrapConfig(){
      fetch("/site-config.json", {cache:"no-store"})
        .then(function(r){return r.ok ? r.json() : {};})
        .then(function(cfg){
          if (cfg && cfg.API_BASE && typeof cfg.API_BASE === "string" && cfg.API_BASE.trim()) {
            API_BASE = cfg.API_BASE.trim().replace(/\/+$/, "");
          }
        })
        .catch(function(){ /* keep fallback */ });
    })();

    // -------- Elements ----------
    var countrySel = document.getElementById("country");
    var searchInput = document.getElementById("q");
    var limitSel = document.getElementById("limit");
    var loadBtn = document.getElementById("loadBtn");
    var resetBtn = document.getElementById("resetBtn");
    var prevBtn = document.getElementById("prevBtn");
    var nextBtn = document.getElementById("nextBtn");
    var pageEl = document.getElementById("pageNum");
    var resultsEl = document.getElementById("results");
    var statusEl = document.getElementById("status");

    // -------- State ----------
    var page = 1;
    var lastCount = 0;

    function setStatus(msg){ statusEl.textContent = msg; }

    function fmtDate(iso){
      if (!iso) return "";
      var d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      var now = new Date();
      var diff = (now - d) / 1000;
      if (diff < 60) return "just now";
      if (diff < 3600) return Math.floor(diff/60) + "m ago";
      if (diff < 86400) return Math.floor(diff/3600) + "h ago";
      return d.toLocaleDateString();
    }

    function pct(x){
      var n = Number(x);
      if (!isFinite(n)) return "";
      return Math.round(Math.max(0, Math.min(100, n*100))) + "%";
    }

    function jobUrl(j){
      if (j && j.url) return j.url;
      if (j && j.link) return j.link;
      return "#";
    }

    function jobLocation(j){
      if (!j) return "";
      if (j.location && j.country) return j.location + " (" + j.country + ")";
      if (j.location) return j.location;
      if (j.country_name) return j.country_name;
      if (j.country) return j.country;
      return "";
    }

    function extractItems(payload){
      if (!payload) return [];
      if (Array.isArray(payload)) return payload;
      if (Array.isArray(payload.data)) return payload.data;
      if (Array.isArray(payload.items)) return payload.items;
      if (Array.isArray(payload.results)) return payload.results;
      // backend sometimes returns {jobs:[...]}
      if (Array.isArray(payload.jobs)) return payload.jobs;
      return [];
    }

    function render(items){
      resultsEl.innerHTML = "";
      lastCount = items.length;

      if (!items.length){
        var empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "No jobs found. Try a different search or country.";
        resultsEl.appendChild(empty);
        updatePager();
        return;
      }

      for (var i=0;i<items.length;i++){
        var j = items[i];

        var card = document.createElement("article");
        card.className = "card";

        var grid = document.createElement("div");
        grid.className = "grid";

        var title = document.createElement("div");
        title.className = "title";
        var a = document.createElement("a");
        a.href = jobUrl(j);
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = (j.title || "Untitled role");
        title.appendChild(a);

        var r = document.createElement("div");
        r.className = "right";

        var m = document.createElement("span");
        m.className = "pct";
        m.textContent = j.match != null ? pct(j.match) : "";
        if (!m.textContent) m.style.display = "none";

        var apply = document.createElement("a");
        apply.href = a.href;
        apply.target = "_blank";
        apply.rel = "noopener";
        apply.className = "chip";
        apply.textContent = "View";

        r.appendChild(m);
        r.appendChild(apply);

        grid.appendChild(title);
        grid.appendChild(r);

        var meta = document.createElement("div");
        meta.className = "meta";
        var company = document.createElement("span");
        company.className = "chip";
        company.textContent = j.company ? j.company : "Company N/A";
        var loc = document.createElement("span");
        loc.className = "chip";
        loc.textContent = jobLocation(j) || "Location N/A";
        var src = document.createElement("span");
        src.className = "chip";
        src.textContent = j.source ? ("Source: " + j.source) : "Source: —";
        var posted = document.createElement("span");
        posted.className = "chip";
        posted.textContent = j.posted_at ? ("Posted " + fmtDate(j.posted_at)) :
                           j.created_at ? ("Added " + fmtDate(j.created_at)) : "Date N/A";

        meta.appendChild(company);
        meta.appendChild(loc);
        meta.appendChild(src);
        meta.appendChild(posted);

        card.appendChild(grid);
        card.appendChild(meta);
        resultsEl.appendChild(card);
      }

      updatePager();
    }

    function updatePager(){
      pageEl.textContent = String(page);
      var limit = Number(limitSel.value) || 20;
      prevBtn.disabled = page <= 1;
      // if we received less than limit, likely no more pages
      nextBtn.disabled = lastCount < limit;
    }

    function persist(){
      try{
        localStorage.setItem("jobs.country", countrySel.value || "");
        localStorage.setItem("jobs.q", searchInput.value || "");
        localStorage.setItem("jobs.limit", limitSel.value || "20");
      }catch(e){}
    }
    function restore(){
      try{
        var c = localStorage.getItem("jobs.country") || "";
        var q = localStorage.getItem("jobs.q") || "";
        var l = localStorage.getItem("jobs.limit") || "20";
        if (c) countrySel.value = c;
        if (q) searchInput.value = q;
        limitSel.value = l;
      }catch(e){}
    }

    async function load(pageNumber){
      page = pageNumber || 1;
      persist();

      var limit = Number(limitSel.value) || 20;
      var offset = (page - 1) * limit;
      var country = (countrySel.value || "").trim();
      var q = (searchInput.value || "").trim();

      var qs = new URLSearchParams();
      if (country) qs.set("country", country);
      if (q) qs.set("q", q);
      qs.set("limit", String(limit));
      qs.set("offset", String(offset));

      var url = API_BASE.replace(/\/+$/,"") + "/jobs?" + qs.toString();

      setStatus("Loading…");
      loadBtn.disabled = true; prevBtn.disabled = true; nextBtn.disabled = true;

      try {
        var resp = await fetch(url, {headers: {"Accept":"application/json"}});
        if (!resp.ok) {
          var t = ""; try{ t = await resp.text(); }catch(e){}
          throw new Error("HTTP " + resp.status + " " + t.slice(0,200));
        }
        var payload = {};
        try{ payload = await resp.json(); }catch(e){ payload = []; }

        var items = extractItems(payload);
        render(items);
        setStatus("Loaded " + items.length + " jobs");
      } catch (err) {
        console.error(err);
        setStatus("Error loading jobs: " + (err && err.message ? err.message : String(err)));
        resultsEl.innerHTML = "";
        var card = document.createElement("div");
        card.className = "card";
        card.textContent = "Couldn't load jobs. Please try again.";
        resultsEl.appendChild(card);
      } finally {
        loadBtn.disabled = false;
      }
    }

    function resetFilters(){
      countrySel.value = "";
      searchInput.value = "";
      limitSel.value = "20";
      page = 1;
      load(page);
    }

    // Events
    loadBtn.addEventListener("click", function(){ load(1); });
    resetBtn.addEventListener("click", resetFilters);
    prevBtn.addEventListener("click", function(){ if (page>1) load(page-1); });
    nextBtn.addEventListener("click", function(){ load(page+1); });
    limitSel.addEventListener("change", function(){ load(1); });

    // Auto-load on first paint
    restore();
    load(1);
  </script>
</body>
</html>