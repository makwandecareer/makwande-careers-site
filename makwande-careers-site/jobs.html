<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobs — Makwande Careers</title>
  <style>
    :root {
      --bg: #0e2030; --panel: #13283b; --ink: #eef7ff; --muted:#a8c1d6;
      --accent:#4ade80; --accent-ink:#053a1b; --chip:#163247; --border:#204761;
    }
    html,body { height:100%; }
    body {
      margin:0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1a3a54 0, #0e2030 60%, #0a1824 100%);
      color: var(--ink);
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px 16px 64px; }
    header h1 { margin: 0 0 6px; font-size: clamp(28px, 4vw, 44px); letter-spacing: .5px; }
    header p { margin: 0 0 22px; color: var(--muted); }
    .controls {
      display:grid; gap:12px; grid-template-columns: 1fr; margin: 8px 0 18px;
    }
    @media (min-width: 720px){
      .controls { grid-template-columns: 220px 1fr 120px auto auto; align-items:end; }
    }
    label { display:block; font-size:12px; color: var(--muted); margin:0 0 6px; }
    select, input[type="text"], input[type="number"] {
      width:100%; padding:10px 11px; border-radius:10px; border:1px solid var(--border);
      background: var(--chip); color: var(--ink);
    }
    .btn {
      appearance:none; border:0; padding:10px 14px; border-radius:12px; cursor:pointer;
      background: var(--accent); color: var(--accent-ink); font-weight:600;
      box-shadow: 0 6px 18px rgba(74,222,128,.18);
    }
    .btn.secondary { background: #2b3f52; color:#e7f4ff; box-shadow: none; border:1px solid var(--border); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .status { min-height: 22px; color: var(--muted); margin: 6px 0 6px; }
    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 720px){ .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1024px){ .grid { grid-template-columns: repeat(3, 1fr); } }
    .card {
      background: linear-gradient(180deg, var(--panel), #112538);
      border: 1px solid var(--border);
      padding:14px 14px 12px; border-radius:16px;
    }
    .card h3 { margin:0 0 6px; font-size: 16px; }
    .card h3 a { color: var(--ink); text-decoration:none; }
    .meta { font-size: 12px; color: var(--muted); display:flex; flex-wrap:wrap; gap:8px; }
    .chip { background:#0f2233; border:1px solid var(--border); padding:2px 8px; border-radius:999px; }
    .footer { display:flex; align-items:center; gap:10px; margin-top:12px; }
    .pager { display:flex; align-items:center; gap:10px; margin:14px 0 0; }
    .pager .page { width:46px; text-align:center; background:transparent; color:var(--muted); border:0; }
    .empty { padding:18px; border-radius:12px; border:1px dashed var(--border); color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Makwande Careers</h1>
      <p>Fresh roles across the SADC region.</p>
    </header>

    <section class="controls" id="controls">
      <div>
        <label for="country">Country</label>
        <select id="country"></select>
      </div>
      <div>
        <label for="q">Search</label>
        <input id="q" type="text" placeholder="e.g. data, finance, graduate" />
      </div>
      <div>
        <label for="limit">Limit</label>
        <select id="limit">
          <option>10</option><option selected>20</option><option>30</option><option>50</option>
        </select>
      </div>
      <button class="btn" id="load">Load Jobs</button>
      <button class="btn secondary" id="reset">Reset</button>
    </section>

    <div class="status" id="status" aria-live="polite"></div>

    <section class="pager">
      <button class="btn secondary" id="prev" disabled>Prev</button>
      <span class="page" id="pageNum">1</span>
      <button class="btn secondary" id="next" disabled>Next</button>
    </section>

    <section class="grid" id="results" aria-live="polite"></section>
  </div>

  <script>
  (async () => {
    // ---------- small helpers ----------
    const $ = (id) => document.getElementById(id);
    const resultsEl = $("results");
    const statusEl  = $("status");
    const countryEl = $("country");
    const qEl       = $("q");
    const limitEl   = $("limit");
    const prevBtn   = $("prev");
    const nextBtn   = $("next");
    const pageEl    = $("pageNum");
    const loadBtn   = $("load");
    const resetBtn  = $("reset");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setLoading(is){ loadBtn.disabled = is; prevBtn.disabled = is || state.page<=1; nextBtn.disabled = is; }

    // ---------- SADC-10 countries ----------
    const COUNTRIES = [
      { code:"ZA", name:"South Africa" },
      { code:"NA", name:"Namibia" },
      { code:"BW", name:"Botswana" },
      { code:"ZW", name:"Zimbabwe" },
      { code:"ZM", name:"Zambia" },
      { code:"MZ", name:"Mozambique" },
      { code:"AO", name:"Dr Congo" },
      { code:"MW", name:"Malawi" },
      { code:"LS", name:"Lesotho" },
      { code:"SZ", name:"Eswatini" }
    ];
    countryEl.innerHTML =
      <option value="">All locations</option> +
      COUNTRIES.map(c => <option value="${c.code}">${c.name}</option>).join("");

    // ---------- config: API base ----------
    // 1) URL ?api= override for testing
    const urlParams = new URLSearchParams(location.search);
    let API_BASE = urlParams.get("api") || "";

    // 2) Try site-config.json (non-blocking)
    try {
      const r = await fetch("site-config.json", { cache:"no-store" });
      if (r.ok) {
        const cfg = await r.json().catch(() => ({}));
        if (!API_BASE && cfg && typeof cfg.API_BASE === "string" && cfg.API_BASE.trim()) {
          API_BASE = cfg.API_BASE.trim().replace(/\/+$/,'');
        }
      }
    } catch(_) { /* ignore */ }

    // 3) Hard fallback (current Render API)
    if (!API_BASE) API_BASE = "https://autoapplyapp.onrender.com";

    // ---------- state ----------
    const state = {
      page: Number(urlParams.get("page") || 1),
      limit: Number(urlParams.get("limit") || limitEl.value),
      q: urlParams.get("q") || "",
      country: urlParams.get("country") || ""
    };
    pageEl.textContent = state.page;
    limitEl.value = String(state.limit);
    qEl.value = state.q;
    countryEl.value = state.country;

    // ---------- build URL ----------
    function buildURL(page){
      const offset = (page - 1) * state.limit;
      const qs = new URLSearchParams();
      if (state.country) qs.set("country", state.country);
      if (state.q) qs.set("q", state.q);
      qs.set("limit", String(state.limit));
      if (offset > 0) qs.set("offset", String(offset));
      return ${API_BASE.replace(/\/+$/,'')}/jobs? + qs.toString();
    }

    // ---------- render ----------
    function render(items){
      resultsEl.innerHTML = "";
      if (!items || !items.length){
        resultsEl.innerHTML = <div class="empty">No results yet. Try a different search or country.</div>;
        return;
      }
      const frag = document.createDocumentFragment();
      for (const job of items){
        const card = document.createElement("article");
        card.className = "card";
        const title = job.title || "Untitled role";
        const company = job.company || "—";
        const location = job.location || job.country_name || job.country || "—";
        const source = job.source || "web";
        const match = (typeof job.match === "number") ? Math.round(job.match) : null;
        const url = job.url || "#";
        const posted = job.posted_at ? new Date(job.posted_at) : null;

        card.innerHTML = `
          <h3><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
          <div class="meta">
            <span class="chip">${company}</span>
            <span class="chip">${location}</span>
            <span class="chip">Source: ${source}</span>
            ${match !== null ? <span class="chip">Match: ${match}%</span> : ``}
            ${posted ? <span class="chip">Posted: ${posted.toLocaleDateString()}</span> : ``}
          </div>
        `;
        frag.appendChild(card);
      }
      resultsEl.appendChild(frag);
    }

    // ---------- loader ----------
    async function load(page = 1){
      state.page = Math.max(1, Number(page) || 1);
      pageEl.textContent = state.page;

      // keep URL in address bar tidy (no reload)
      const qs = new URLSearchParams();
      if (state.country) qs.set("country", state.country);
      if (state.q) qs.set("q", state.q);
      if (state.limit) qs.set("limit", String(state.limit));
      if (state.page > 1) qs.set("page", String(state.page));
      history.replaceState(null, "", location.pathname + (qs.toString()??${qs.toString()}:""));

      const url = buildURL(state.page);
      setStatus("Loading…");
      setLoading(true);

      try {
        const resp = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
        if (!resp.ok) {
          const txt = await resp.text().catch(()=>String(resp.status));
          throw new Error(HTTP ${resp.status}: ${txt.slice(0,200)});
        }
        let payload = [];
        try { payload = await resp.json(); } catch { payload = []; }

        // API may return {items:[...]} or raw array; normalize
        const items = Array.isArray(payload) ? payload
                     : Array.isArray(payload.items) ? payload.items
                     : [];
        render(items);

        // pager buttons
        prevBtn.disabled = state.page <= 1;
        nextBtn.disabled = items.length < state.limit;
        setStatus(Loaded ${items.length} job${items.length===1?"":"s"}.);
      } catch (err){
        console.error(err);
        render([]);
        prevBtn.disabled = state.page <= 1;
        nextBtn.disabled = true;
        setStatus("Error: " + (err && err.message ? err.message : "couldn’t load jobs."));
      } finally {
        setLoading(false);
      }
    }

    // ---------- events ----------
    loadBtn.addEventListener("click", () => {
      state.country = countryEl.value.trim();
      state.q = qEl.value.trim();
      state.limit = Number(limitEl.value) || 20;
      load(1);
    });

    resetBtn.addEventListener("click", () => {
      countryEl.value = "";
      qEl.value = "";
      limitEl.value = "20";
      state.country = ""; state.q = ""; state.limit = 20;
      load(1);
    });

    nextBtn.addEventListener("click", () => load(state.page + 1));
    prevBtn.addEventListener("click", () => load(state.page - 1));
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") load(1); });

    // ---------- initial auto-load ----------
    await load(state.page);
  })();
  </script>
</body>
</html>