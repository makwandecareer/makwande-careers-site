<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobs – Makwande Careers</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --text:#e5e7eb; --border:#1f2937;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:blur(6px)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0 0 2px;font-size:28px}
    .sub{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
    select,input,button{
      background:#0b1222;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px
    }
    button{cursor:pointer;border-color:#1f2937;background:#09111f}
    button.primary{background:var(--accent);border-color:transparent;color:#062a10;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;gap:10px;flex-direction:column}
    .title{font-weight:700}
    .meta{color:var(--muted);font-size:13px;display:flex;gap:12px;flex-wrap:wrap}
    .badge{background:#0a1a12;color:#76f0ae;border:1px solid #164b2e;padding:2px 8px;border-radius:999px;font-size:12px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .link{color:#9ae6b4;text-decoration:none}
    .error{background:#3b0d0d;border:1px solid #5f1515;color:#ffd2d2;padding:10px 12px;border-radius:10px;margin:12px 0}
    .muted{color:var(--muted)}
    .empty{border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center}
    .pager{display:flex;gap:8px;justify-content:center;margin:18px 0}
    .spinner{width:22px;height:22px;border:3px solid #284258;border-top-color:#76f0ae;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    .row{display:flex;align-items:center;gap:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Makwande Careers</h1>
      <div class="sub">Fresh roles across the SADC region.</div>
      <div class="controls">
        <label>
          <span class="muted">Country</span><br/>
          <select id="country"></select>
        </label>
        <label>
          <span class="muted">Search</span><br/>
          <input id="q" type="search" placeholder="e.g. data, finance, graduate…" />
        </label>
        <label>
          <span class="muted">Limit</span><br/>
          <select id="limit">
            <option>10</option><option selected>20</option><option>30</option><option>50</option>
          </select>
        </label>
        <div style="align-self:end;display:flex;gap:8px">
          <button id="refresh" class="primary">Load Jobs</button>
          <button id="reset">Reset</button>
        </div>
      </div>
      <div id="status" class="row muted" style="min-height:24px"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No jobs found. Try a different country or search term.</div>
    <div class="pager">
      <button id="prev">Prev</button>
      <div id="page" class="muted">1</div>
      <button id="next">Next</button>
    </div>
  </main>

<script>
  // ====== CONFIG ======
  const API_BASE = 'https://autoapplyapp.onrender.com/api';
  // The 10 SADC defaults (edit to your exact set if needed)
  const COUNTRY_OPTIONS = [
    {code:'ZA', name:'South Africa'},
    {code:'BW', name:'Botswana'},
    {code:'NA', name:'Namibia'},
    {code:'ZM', name:'Zambia'},
    {code:'ZW', name:'Zimbabwe'},
    {code:'MZ', name:'Mozambique'},
    {code:'AO', name:'Angola'},
    {code:'TZ', name:'Tanzania'},
    {code:'MW', name:'Malawi'},
    {code:'LS', name:'Lesotho'},
  ];

  // ====== STATE ======
  let state = {
    page: 1,
    limit: 20,
    country: localStorage.getItem('country') || 'ZA',
    q: ''
  };

  // ====== DOM ======
  const countrySel = document.getElementById('country');
  const qInput      = document.getElementById('q');
  const limitSel    = document.getElementById('limit');
  const refreshBtn  = document.getElementById('refresh');
  const resetBtn    = document.getElementById('reset');
  const prevBtn     = document.getElementById('prev');
  const nextBtn     = document.getElementById('next');
  const pageLbl     = document.getElementById('page');
  const listEl      = document.getElementById('list');
  const emptyEl     = document.getElementById('empty');
  const statusEl    = document.getElementById('status');
  const errEl       = document.getElementById('err');

  // ====== UTILS ======
  function fmtDate(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
  }
  function relTime(iso){
    if(!iso) return '';
    const d = new Date(iso).getTime(), now = Date.now(), diff = Math.max(1, Math.round((now-d)/1000));
    const units = [[31536000,'y'],[2592000,'mo'],[604800,'w'],[86400,'d'],[3600,'h'],[60,'m'],[1,'s']];
    for(const [s, label] of units){ if(diff >= s) return Math.floor(diff/s)+label+' ago'; }
    return 'just now';
  }
  function setLoading(isLoading){
    statusEl.innerHTML = isLoading
      ? <div class="spinner"></div> Loading…
      : '';
  }
  function showError(msg){
    errEl.style.display='block';
    errEl.textContent = msg || 'Could not load jobs.';
  }
  function clearError(){ errEl.style.display='none'; }

  // ====== RENDER ======
  function renderJobs(rows){
    listEl.innerHTML = '';
    if(!rows || rows.length===0){
      emptyEl.style.display='block';
      return;
    }
    emptyEl.style.display='none';
    for(const j of rows){
      const match = j.match != null ? Math.round(Number(j.match) * 100) : null;
      const loc = j.location || j.country || '';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="title">${escapeHtml(j.title || '(Untitled)')}</div>
        <div class="meta">
          <span>${escapeHtml(j.company || 'Unknown')}</span>
          ${loc ? <span>• ${escapeHtml(loc)}</span>:''}
          ${j.source ? <span>• ${escapeHtml(j.source)}</span>:''}
        </div>
        <div class="meta">
          ${j.posted_at ? <span class="badge" title="${fmtDate(j.posted_at)}">posted ${relTime(j.posted_at)}</span>:''}
          ${match!=null ? <span class="badge" title="Match score">${match}% match</span>:''}
        </div>
        <div class="footer">
          <a class="link" href="${encodeURI(j.url || '#')}" target="_blank" rel="noopener">View & Apply →</a>
          <span class="muted">${fmtDate(j.created_at)}</span>
        </div>
      `;
      listEl.appendChild(card);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ====== DATA ======
  async function fetchJobs(){
    clearError();
    setLoading(true);
    const params = new URLSearchParams();
    params.set('limit', state.limit);
    params.set('offset', (state.page-1)*state.limit);
    if(state.country) params.set('country', state.country);
    if(state.q) params.set('q', state.q);

    const url = ${API_BASE}/jobs?${params.toString()};
    pageLbl.textContent = state.page;

    try{
      const res = await fetch(url, {headers:{'accept':'application/json'}});
      if(!res.ok){
        const text = await res.text();
        throw new Error(API ${res.status}: ${text || res.statusText});
      }
      const data = await res.json();
      // support either {items:[...]} or raw array
      const rows = Array.isArray(data) ? data : (data.items || data.rows || data.results || []);
      renderJobs(rows);
    }catch(err){
      showError(err.message);
      console.error('Fetch error:', err);
    }finally{
      setLoading(false);
    }
  }

  // ====== INIT ======
  (function init(){
    // populate countries
    countrySel.innerHTML = COUNTRY_OPTIONS
      .map(c => <option value="${c.code}">${c.name}</option>).join('');
    // restore country if present in URL ?country=XX
    const u = new URL(window.location.href);
    const urlCountry = u.searchParams.get('country');
    if(urlCountry) state.country = urlCountry.toUpperCase();
    countrySel.value = state.country;

    limitSel.value = String(state.limit);
    qInput.value = state.q;

    // events
    countrySel.addEventListener('change', () => {
      state.country = countrySel.value;
      state.page = 1;
      localStorage.setItem('country', state.country);
      fetchJobs();
    });
    limitSel.addEventListener('change', () => {
      state.limit = Number(limitSel.value) || 20;
      state.page = 1;
      fetchJobs();
    });
    qInput.addEventListener('keyup', e => {
      if(e.key === 'Enter'){ state.q = qInput.value.trim(); state.page=1; fetchJobs(); }
    });
    refreshBtn.addEventListener('click', () => {
      state.q = qInput.value.trim();
      state.page = 1;
      fetchJobs();
    });
    resetBtn.addEventListener('click', () => {
      qInput.value = '';
      state.q = '';
      state.page = 1;
      fetchJobs();
    });
    prevBtn.addEventListener('click', () => { if(state.page>1){ state.page--; fetchJobs(); }});
    nextBtn.addEventListener('click', () => { state.page++; fetchJobs(); });

    // initial load
    fetchJobs();
  })();
</script>
</body>
</html>