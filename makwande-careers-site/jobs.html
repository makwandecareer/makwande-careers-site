<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jobs — Makwande Careers</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg1:#0d1720; --bg2:#101a24;
      --panel:#0f1f2a; --panel-hi:#122536;
      --ink:#f8fafc; --muted:#d2dee8cc;
      --brand:#f59e0b;        /* warm amber */
      --brand-ink:#2b1600;
      --chip:#0f2433; --border:#1d3a4e;
      --ok:#22c55e;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg1:#fffaf3; --bg2:#fff7ec;
        --panel:#ffffff; --panel-hi:#fffdf8;
        --ink:#0b1220; --muted:#42566bcc;
        --chip:#f6f7f9; --border:#e7edf2;
      }
      body{ background: radial-gradient(1300px 600px at 10% -10%, #fff0d8 0, #fff7ec 30%, #fffaf3 70%); }
    }
    body{
      margin:0; color:var(--ink);
      background: radial-gradient(1300px 600px at 10% -10%, #1a2936 0, #0f1c27 45%, #0d1720 100%);
      font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    .wrap{ max-width: 1120px; margin:0 auto; padding:24px 14px 72px; }
    header{
      background:
        radial-gradient(800px 280px at 10% -40%, rgba(245,158,11,.18), transparent 40%),
        linear-gradient(180deg, transparent, transparent 70%, rgba(245,158,11,.06));
      border: 1px solid rgba(245,158,11,.18);
      border-radius: 18px;
      padding: 22px 18px 20px;
      box-shadow: 0 10px 40px rgba(245,158,11,.05), 0 8px 30px rgba(0,0,0,.25) inset;
      margin: 4px 0 18px;
    }
    h1{ margin:0 0 6px; font-weight:800; letter-spacing:.3px; font-size: clamp(28px, 4.4vw, 44px); }
    header p{ margin:0; color:var(--muted); }

    /* controls */
    .controls{
      display:grid; gap:12px; grid-template-columns: 1fr;
      margin: 16px 0 8px;
    }
    @media (min-width: 780px){
      .controls{ grid-template-columns: 220px 1fr 120px auto auto; align-items:end; }
    }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; letter-spacing:.3px; }
    select,input[type="text"],input[type="number"]{
      width:100%; padding:11px 12px; border-radius:12px;
      background:var(--chip); color:var(--ink);
      border:1px solid var(--border); outline: none;
      box-shadow: 0 2px 0 rgba(0,0,0,.12) inset, 0 8px 26px rgba(0,0,0,.12);
    }
    .btn{
      appearance:none; border:0; padding:11px 16px; border-radius:14px; cursor:pointer;
      background: linear-gradient(180deg, #f8b84a, var(--brand));
      color:var(--brand-ink); font-weight:800; letter-spacing:.2px;
      box-shadow: 0 10px 24px rgba(245,158,11,.25), 0 2px 0 rgba(0,0,0,.12) inset;
      transform: translateZ(0);
    }
    .btn.secondary{
      background: linear-gradient(180deg, var(--panel-hi), var(--panel));
      color: var(--ink); border:1px solid var(--border); box-shadow:none; font-weight:600;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .status{ min-height: 22px; color:var(--muted); margin: 8px 4px 2px; }

    /* cards */
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; margin-top:12px; }
    @media (min-width: 760px){ .grid{ grid-template-columns: repeat(2,1fr); } }
    @media (min-width: 1060px){ .grid{ grid-template-columns: repeat(3,1fr); } }
    .card{
      background: linear-gradient(180deg, var(--panel-hi), var(--panel));
      border:1px solid var(--border); border-radius:16px; padding:14px 16px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
    }
    .card h3{ margin:0 0 8px; font-size:17px; }
    .card h3 a{ color:var(--ink); text-decoration:none; }
    .meta{ display:flex; flex-wrap:wrap; gap:8px; color:var(--muted); font-size:12px; }
    .chip{ background: #112b3a; border:1px solid var(--border); padding:2px 8px; border-radius:999px; }
    .ok{ color:var(--ok); font-weight:700; }
    .empty{
      padding:18px; border-radius:14px; border:1px dashed var(--border);
      color:var(--muted); background: linear-gradient(180deg, rgba(245,158,11,.05), transparent);
    }
    .pager{ display:flex; align-items:center; gap:10px; margin:16px 2px 0; }
    .page{ width:46px; text-align:center; color:var(--muted); }
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px; background:#1a2d3d; color:#fff; border:1px solid #22455c;
      padding: 10px 14px; border-radius: 12px; box-shadow: 0 12px 28px rgba(0,0,0,.25);
      max-width: 92vw; display:none;
    }
    .skeleton{ height:118px; border-radius:16px; background:
      linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.02), rgba(255,255,255,.08));
      animation: sh 1.4s infinite; border:1px solid var(--border);
    }
    @keyframes sh{ 0%{ background-position:-240px 0 } 100%{ background-position:240px 0 } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Makwande Careers</h1>
      <p>Warm opportunities across the SADC region — refreshed hourly.</p>
    </header>

    <section class="controls" id="controls">
      <div>
        <label for="country">Country</label>
        <select id="country"></select>
      </div>
      <div>
        <label for="q">Search</label>
        <input id="q" type="text" placeholder="e.g. data, finance, graduate" />
      </div>
      <div>
        <label for="limit">Limit</label>
        <select id="limit">
          <option>10</option><option selected>20</option><option>30</option><option>50</option>
        </select>
      </div>
      <button class="btn" id="load">Load Jobs</button>
      <button class="btn secondary" id="reset">Reset</button>
    </section>

    <div class="status" id="status" aria-live="polite"></div>

    <section class="pager">
      <button class="btn secondary" id="prev" disabled>Prev</button>
      <span class="page" id="pageNum">1</span>
      <button class="btn secondary" id="next" disabled>Next</button>
    </section>

    <section class="grid" id="results" aria-live="polite"></section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (async () => {
    const $ = (id) => document.getElementById(id);
    const resultsEl = $("results"), statusEl = $("status"), toastEl = $("toast");
    const countryEl = $("country"), qEl = $("q"), limitEl = $("limit");
    const prevBtn = $("prev"), nextBtn = $("next"), pageEl = $("pageNum");
    const loadBtn = $("load"), resetBtn = $("reset");

    const COUNTRIES = [
      { code:"ZA", name:"South Africa" },
      { code:"NA", name:"Namibia" },
      { code:"BW", name:"Botswana" },
      { code:"ZW", name:"Zimbabwe" },
      { code:"ZM", name:"Zambia" },
      { code:"MZ", name:"Mozambique" },
      { code:"AO", name:"Dr Congo" },
      { code:"MW", name:"Malawi" },
      { code:"LS", name:"Lesotho" },
      { code:"SZ", name:"Eswatini" }
    ];
    countryEl.innerHTML =
      <option value="">All locations</option> +
      COUNTRIES.map(c => <option value="${c.code}">${c.name}</option>).join("");

    function setStatus(t){ statusEl.textContent = t || ""; }
    function toast(t){ toastEl.textContent = t; toastEl.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.display="none", 4000); }
    function setLoading(on){
      loadBtn.disabled = on; prevBtn.disabled = on || state.page<=1; nextBtn.disabled = on;
      resultsEl.classList.toggle("loading", !!on);
    }
    function skeleton(n=6){
      resultsEl.innerHTML = ""; for(let i=0;i<n;i++){ const d=document.createElement("div"); d.className="skeleton"; resultsEl.appendChild(d); }
    }

    const urlParams = new URLSearchParams(location.search);
    const state = {
      page: Number(urlParams.get("page") || 1),
      limit: Number(urlParams.get("limit") || 20),
      q: (urlParams.get("q") || "").trim(),
      country: urlParams.get("country") || ""
    };
    pageEl.textContent = state.page; limitEl.value = String(state.limit); qEl.value = state.q; countryEl.value = state.country;

    // -------- API base (robust) --------
    let API_BASE = (urlParams.get("api") || "").trim();
    async function readConfig(){
      try{
        const r = await fetch("/site-config.json", { cache:"no-store" });
        if (!r.ok) return;
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return;   // avoid parsing HTML/SPA shell
        const cfg = await r.json().catch(()=> ({}));
        if (!API_BASE && cfg && typeof cfg.API_BASE === "string" && cfg.API_BASE.trim()){
          API_BASE = cfg.API_BASE.trim().replace(/\/+$/,'');
        }
      }catch(_){}
    }
    await readConfig();
    if (!API_BASE) API_BASE = "https://autoapplyapp.onrender.com";

    function buildURL(page){
      const offset = (page-1) * state.limit;
      const qs = new URLSearchParams();
      if (state.country) qs.set("country", state.country);
      if (state.q) qs.set("q", state.q);
      qs.set("limit", String(state.limit));
      if (offset>0) qs.set("offset", String(offset));
      return API_BASE.replace(/\/+$/,'') + "/jobs?" + qs.toString();
    }

    function render(items){
      resultsEl.innerHTML = "";
      if (!items || !items.length){
        resultsEl.innerHTML = <div class="empty">No results right now. Try a broader search or a different country.</div>;
        return;
      }
      const frag = document.createDocumentFragment();
      for (const job of items){
        const a = document.createElement("article");
        a.className = "card";
        const title = job.title || "Untitled role";
        const company = job.company || "—";
        const loc = job.location || job.country_name || job.country || "—";
        const src = job.source || "web";
        const match = (typeof job.match === "number") ? Math.round(job.match) : null;
        const url = job.url || "#";
        const posted = job.posted_at ? new Date(job.posted_at) : null;

        a.innerHTML = `
          <h3><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
          <div class="meta">
            <span class="chip">${company}</span>
            <span class="chip">${loc}</span>
            <span class="chip">Source: ${src}</span>
            ${match !== null ? <span class="chip ok">Match: ${match}%</span> : ``}
            ${posted ? <span class="chip">Posted: ${posted.toLocaleDateString()}</span> : ``}
          </div>`;
        frag.appendChild(a);
      }
      resultsEl.appendChild(frag);
    }

    async function load(page=1){
      state.page = Math.max(1, Number(page) || 1);
      pageEl.textContent = state.page;

      const qs = new URLSearchParams();
      if (state.country) qs.set("country", state.country);
      if (state.q) qs.set("q", state.q);
      if (state.limit) qs.set("limit", String(state.limit));
      if (state.page > 1) qs.set("page", String(state.page));
      history.replaceState(null, "", location.pathname + (qs.toString()??${qs.toString()}:""));

      const url = buildURL(state.page);
      setStatus("Loading…");
      setLoading(true);
      skeleton();

      try{
        const resp = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
        const text = await resp.text(); // always read as text first
        if (!resp.ok){ throw new Error(HTTP ${resp.status}: ${text.slice(0,180)}); }

        let data = [];
        try{
          const parsed = JSON.parse(text);
          data = Array.isArray(parsed) ? parsed :
                 (parsed && Array.isArray(parsed.items) ? parsed.items : []);
        }catch{
          data = []; // if backend served HTML/other, avoid console SyntaxError
        }

        render(data);
        prevBtn.disabled = state.page<=1;
        nextBtn.disabled = data.length < state.limit;
        setStatus(Loaded ${data.length} job${data.length===1?"":"s"}.);
      }catch(err){
        console.error(err);
        render([]);
        prevBtn.disabled = state.page<=1; nextBtn.disabled = true;
        setStatus("Couldn’t load jobs.");
        toast("Network/API error: " + (err?.message || "please try again."));
      }finally{
        setLoading(false);
      }
    }

    // events
    loadBtn.addEventListener("click", () => {
      state.country = countryEl.value.trim();
      state.q = qEl.value.trim();
      state.limit = Number(limitEl.value) || 20;
      load(1);
    });
    resetBtn.addEventListener("click", () => {
      countryEl.value=""; qEl.value=""; limitEl.value="20";
      state.country=""; state.q=""; state.limit=20; load(1);
    });
    nextBtn.addEventListener("click", () => load(state.page+1));
    prevBtn.addEventListener("click", () => load(state.page-1));
    qEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") load(1); });

    // initial
    await load(state.page);
  })();
  </script>
</body>
</html>