<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Public Profile — Makwande Careers</title>

  <!-- Basic share metas (will be filled when data loads) -->
  <meta property="og:title" content="Makwande Careers — Candidate" />
  <meta property="og:description" content="Candidate profile on Makwande Careers" />
  <meta property="og:image" content="/assets/img/logo.png" />
  <meta name="theme-color" content="#0f5132" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="/assets/css/style.css" rel="stylesheet" />
  <style>
    .cover { background: linear-gradient(135deg, #eaf4ef, #ffffff); }
    .avatar { width:112px; height:112px; object-fit:cover; border-radius:50%; border:4px solid #fff; box-shadow: var(--shadow); }
    .chip { display:inline-block; padding:.35rem .65rem; border:1px solid var(--border); border-radius:999px; background:#fff; margin:.2rem; font-size:.9rem; }
    .card-soft { border:1px solid var(--border); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow); }
    .muted { color:var(--muted); }
  </style>
</head>
<body>
  <!-- Minimal header -->
  <nav class="nav-wrap bg-white sticky-top border-bottom">
    <div class="container-xxl py-2 d-flex align-items-center justify-content-between">
      <a class="d-flex align-items-center gap-2 text-decoration-none" href="/index.html">
        <img src="/assets/img/logo.png" width="28" height="28" alt="Makwande Careers" />
        <strong class="logo-word">Makwande Careers</strong>
      </a>
      <a class="btn btn-outline-success" href="/jobs.html"><i class="bi bi-search"></i> Browse Jobs</a>
    </div>
  </nav>

  <header class="cover py-4">
    <div class="container-xxl d-flex flex-wrap align-items-end gap-3">
        <div class="d-flex flex-wrap gap-2 ms-auto">
            <button class="btn btn-soft" id="btnChangePhoto"><i class="bi bi-camera"></i> Change photo</button>
            <label class="btn btn-primary mb-0" for="resumeInput"><i class="bi bi-upload"></i> Upload CV</label>
            <input id="resumeInput" type="file" accept=".pdf,.doc,.docx" class="visually-hidden">
            <a id="resumeLink" class="btn btn-outline-secondary d-none" href="#" target="_blank" rel="noopener"><i class="bi bi-file-earmark-text"></i> View CV</a>
          </div>  
  </header>

  <main class="container-xxl my-4">
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card-soft p-3 mb-3">
          <h5 class="mb-2">About</h5>
          <div id="about" class="text-body-secondary">No summary provided.</div>
        </div>

        <div class="card-soft p-3 mb-3">
          <h5 class="mb-2">Experience</h5>
          <div id="experience">No experience added yet.</div>
        </div>

        <div class="card-soft p-3">
          <h5 class="mb-2">Education</h5>
          <div id="education">No education added yet.</div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card-soft p-3 mb-3">
          <h6 class="mb-2">Skills</h6>
          <div id="skills"></div>
        </div>
        <div class="card-soft p-3">
          <h6 class="mb-2">Resume</h6>
          <a id="resume" class="btn btn-outline-secondary w-100 d-none" target="_blank" rel="noopener">
            <i class="bi bi-file-earmark-text"></i> View CV
          </a>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-top mt-5 py-4">
    <div class="container-xxl small text-muted">© <span id="year"></span> Makwande Careers</div>
  </footer>

  <!-- 1) 1-line API helper -->
  <script>window.fetchAPI=(p,o={})=>fetch('/api'+p,{credentials:'include',...o});</script>
  <!-- 2) Vendor + shared app JS (if you want nav injection, keep it) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/assets/js/main.js"></script>

  <!-- 3) Page logic -->
  <script type="module">
    const $ = s => document.querySelector(s);
    const y = $('#year'); if (y) y.textContent = new Date().getFullYear();

    // Get ?id= (or ?handle=)
    const q = new URLSearchParams(location.search);
    const id = q.get('id') || q.get('handle') || '';

    // Robust fetcher: try common public endpoints; fall back to /profile?id=…
    async function getPublicProfile() {
      const paths = id
        ? [`/public/profile?id=${encodeURIComponent(id)}`,
           `/profile/public?id=${encodeURIComponent(id)}`,
           `/profile?id=${encodeURIComponent(id)}`]
        : [`/public/profile`, `/profile/public`, `/profile`];

      for (const base of paths) {
        const r = await fetchAPI(base);
        if (r.ok) return r.json();
      }
      throw new Error('profile not found');
    }

    const escape = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const fmtMonth = v => v ? new Date(v+'-01').toLocaleString(undefined,{month:'short',year:'numeric'}) : '';

    try {
      const p = await getPublicProfile();

      // Header
      $('#name').textContent = p.name || 'Candidate';
      $('#headline').textContent = p.headline || '';
      $('#location').textContent = p.location || 'SADC Region';
      if (p.photo_url) $('#avatar').src = p.photo_url;

      // About
      $('#about').innerHTML = p.about ? escape(p.about) : '<span class="text-muted">No summary provided.</span>';

      // Skills
      const skills = (p.skills || []).slice(0, 20);
      $('#skills').innerHTML = skills.length ? skills.map(s=>`<span class="chip">${escape(s)}</span>`).join('') : '<span class="text-muted">No skills listed.</span>';

      // Experience
      const exp = (p.experience || []).slice(0, 8);
      $('#experience').innerHTML = exp.length
        ? exp.map(e=>`
            <div class="py-2">
              <div class="fw-semibold">${escape(e.title||'')} ${e.company? '· <span class="text-muted">'+escape(e.company)+'</span>':''}</div>
              <div class="small text-muted">${fmtMonth(e.start)} – ${e.end?fmtMonth(e.end):'Present'}</div>
              ${e.description ? `<div class="small mt-1">${escape(e.description)}</div>` : ''}
            </div>`).join('')
        : '<span class="text-muted">No experience added yet.</span>';

      // Education
      const edu = (p.education || []).slice(0, 8);
      $('#education').innerHTML = edu.length
        ? edu.map(e=>`
            <div class="py-2">
              <div class="fw-semibold">${escape(e.degree||'')} ${e.school? '· <span class="text-muted">'+escape(e.school)+'</span>':''}</div>
              <div class="small text-muted">${fmtMonth(e.start)} – ${e.end?fmtMonth(e.end):'Present'}</div>
              ${e.notes ? `<div class="small mt-1">${escape(e.notes)}</div>` : ''}
            </div>`).join('')
        : '<span class="text-muted">No education added yet.</span>';

      // Resume link
      if (p.resume_url) { const a = $('#resume'); a.href = p.resume_url; a.classList.remove('d-none'); }

      // Update share metas for prettier link cards
      document.querySelector('meta[property="og:title"]').setAttribute('content', (p.name||'Candidate')+' — Makwande Careers');
      document.querySelector('meta[property="og:description"]').setAttribute('content', p.headline || 'Candidate profile');
      if (p.photo_url) document.querySelector('meta[property="og:image"]').setAttribute('content', p.photo_url);

      // “Contact” CTA (could point to recruiter portal)
      const cta = $('#cta');
      if (p.contact_url) cta.href = p.contact_url;
    } catch (e) {
      document.body.insertAdjacentHTML('beforeend',
        `<div class="container-xxl my-5"><div class="alert alert-warning">Profile not available.</div></div>`);
    }
  </script>
</body>
</html>
